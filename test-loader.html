<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ElemenTails — Data Test Loader</title>
  <style>
    :root{color-scheme:dark}
    body{font:14px/1.5 system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:0; background:#0b1220; color:#e6edf3}
    header,footer{padding:16px 20px; background:#0f172a; position:sticky; top:0; z-index:2; border-bottom:1px solid #1f2937}
    main{padding:16px 20px; display:grid; gap:16px}
    h1{font-size:20px; margin:0 0 8px}
    .row{display:flex; flex-wrap:wrap; gap:8px}
    button{background:#2563eb;border:1px solid #1d4ed8;color:white;border-radius:10px;padding:8px 12px;cursor:pointer}
    button.secondary{background:#1f2937;border-color:#374151;color:#d1d5db}
    pre{background:#0f172a;border:1px solid #1f2937;padding:12px;border-radius:12px;overflow:auto; max-height:40vh}
    .card{background:#0f172a;border:1px solid #1f2937;border-radius:12px;padding:12px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #1f2937;padding:6px 8px;text-align:center}
    th{background:#111827;position:sticky; top:0}
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  </style>
</head>
<body>
  <header>
    <h1>ElemenTails — Data Test Loader</h1>
    <div class="row">
      <button id="btnLoad">Load JSON files</button>
      <button id="btnShowChain" class="secondary">Try chainDamage.js</button>
      <button id="btnShowShop" class="secondary">Try shopLogic.js</button>
    </div>
    <div id="status" style="margin-top:8px;opacity:.85"></div>
  </header>

  <main>
    <section class="card">
      <h2 style="margin:0 0 8px">Element Multipliers (<code>source/data/elements_multipliers.json</code>)</h2>
      <div id="multTbl">Not loaded yet.</div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px">Elemental Dice (<code>source/data/elemental_dice.json</code>)</h2>
      <pre id="dicePre">Not loaded yet.</pre>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px">Console Output</h2>
      <pre id="logPre"></pre>
    </section>
  </main>

  <footer>
    Paths assumed relative to this file at the repo root.
  </footer>

<script type="module">
const $ = (id)=>document.getElementById(id);
const status = $("status");
const logPre = $("logPre");

function log(...args){
  console.log(...args);
  logPre.textContent += args.map(a=> typeof a==="string"? a : JSON.stringify(a,null,2)).join(" ") + "\\n";
}

async function safeFetch(path){
  try{
    const res = await fetch(path + "?t=" + Date.now());
    if(!res.ok) throw new Error(res.status + " " + res.statusText);
    return await res.json();
  }catch(err){
    log("❌ Fetch failed:", path, String(err));
    throw err;
  }
}

function renderMultipliers(json){
  if(!json || !json.order || !json.table) return $("multTbl").textContent = "Invalid JSON.";
  const els = json.order;
  const tbl = document.createElement("table");
  const thead = document.createElement("thead");
  const trh = document.createElement("tr");
  trh.appendChild(document.createElement("th")); // corner
  els.forEach(e=>{
    const th = document.createElement("th");
    th.textContent = e;
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  tbl.appendChild(thead);

  const tbody = document.createElement("tbody");
  els.forEach(att=>{
    const tr = document.createElement("tr");
    const th = document.createElement("th");
    th.textContent = att;
    tr.appendChild(th);
    els.forEach(def=>{
      const td = document.createElement("td");
      td.textContent = json.table[att]?.[def] ?? "";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
  const host = $("multTbl");
  host.innerHTML = "";
  host.appendChild(tbl);
}

async function loadJsons(){
  status.textContent = "Loading…";
  try{
    const multipliers = await safeFetch("./source/data/elements_multipliers.json");
    renderMultipliers(multipliers);

    const dice = await safeFetch("./source/data/elemental_dice.json");
    $("dicePre").textContent = JSON.stringify(dice, null, 2);

    status.textContent = "Loaded JSON successfully.";
  }catch(err){
    status.textContent = "One or more files failed to load. See Console Output below.";
  }
}

$("btnLoad").addEventListener("click", loadJsons);

// Try importing and running chainDamage.js if present
$("btnShowChain").addEventListener("click", async ()=>{
  try{
    const mod = await import("./source/utils/chainDamage.js");
    if(!mod || (!mod.simulateChain && !mod.simulateChainAttack)){
      log("⚠️ chainDamage.js loaded, but exported function not found. Expected simulateChain or simulateChainAttack.");
      return;
    }
    // Minimal demo call with fake positions
    const simulate = mod.simulateChain || mod.simulateChainAttack;
    const demo = simulate({
      startPos: {q:0, r:0},
      startDamage: 6,
      attackElement: "Lightning",
      targets: [
        {id:"A", pos:{q:1,r:0}, element:"Water"},
        {id:"B", pos:{q:2,r:0}, element:"Air"},
        {id:"C", pos:{q:1,r:1}, element:"Earth"}
      ],
      range: 2
    });
    log("✅ chainDamage demo result:");
    log(demo);
  }catch(err){
    log("❌ Could not import ./source/utils/chainDamage.js", String(err));
  }
});

// Try importing and running shopLogic.js if present
$("btnShowShop").addEventListener("click", async ()=>{
  try{
    const mod = await import("./source/utils/shopLogic.js");
    if(!mod || (!mod.Shop && !mod.createShop)){
      log("⚠️ shopLogic.js loaded, but expected export Shop or createShop not found.");
      return;
    }
    const create = mod.createShop || ((rules)=> new mod.Shop(rules));
    const rules = await safeFetch("./source/data/shop_rules.json").catch(()=>null);
    const shop = create(rules || {});

    // Seed with a tiny deck example if helper exists
    if (shop.initDeck) {
      shop.initDeck({
        minor:[
          {id:"m1", name:"Blazing Slash", costEnergy:"A", mana:{Fire:2}},
          {id:"m2", name:"Steam Jab", costEnergy:"A", mana:{Fire:1, Water:1}},
          {id:"m3", name:"Flare Bloom", costEnergy:"A", mana:{Fire:1, Plant:1}},
          {id:"m4", name:"Water Shield", costEnergy:"D", mana:{Water:2}},
        ],
        major:[
          {id:"M1", name:"Thunder Nova", costEnergy:"U", mana:{Lightning:2}},
          {id:"M2", name:"Quake", costEnergy:"A", mana:{Earth:2}},
        ]
      });
    }

    if (shop.refresh) shop.refresh({free:true});

    log("✅ shopLogic demo — current shop slots:");
    log(shop.getState ? shop.getState() : shop);
  }catch(err){
    log("❌ Could not import ./source/utils/shopLogic.js", String(err));
  }
});
</script>
</body>
</html>
