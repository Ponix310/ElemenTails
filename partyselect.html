<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ElemenTails — Party Select</title>
  <style>
    :root{ --bg:#0b0c10; --panel:#121520; --muted:#9aa4b2; --accent:#20c997; --radius:14px; }
    html,body{height:100%;margin:0;background:var(--bg);color:#e9eef5;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{margin:0;font-size:28px}
    .pill{background:#0f1220;border:1px solid #2a3147;border-radius:999px;padding:6px 10px;font-size:14px}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;background:#1e2433;color:#fff}
    .btn:hover{filter:brightness(1.08)}
    .btn.primary{background:var(--accent);color:#06241e}
    .card{background:var(--panel);padding:18px;border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.35);}
    .grid{display:grid;gap:12px}
    .muted{color:#9aa4b2}
    .players{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:800px){.players{grid-template-columns:1fr}}
    .player{display:flex;align-items:center;justify-content:space-between;background:#0f1220;border:1px solid #2a3147;border-radius:10px;padding:10px 12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .note{font-size:12px;color:#9aa4b2;margin-left:6px}
  </style>

  <!-- Firebase v12 (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, collection, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // ---- config (same working project as main menu) ----
    const firebaseConfig = {
      apiKey: "AIzaSyBaIjbM7dVNjKE7CJXPQOievhkiIF17rds",
      authDomain: "elementails.firebaseapp.com",
      projectId: "elementails",
      storageBucket: "elementails.firebasestorage.app",
      messagingSenderId: "497100635124",
      appId: "1:497100635124:web:aeeb25ead96b84751e57a1"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ---- utils ----
    const $ = sel => document.querySelector(sel);
    const params = new URLSearchParams(location.search);
    const roomId = params.get('roomId') || (window.Session && Session.getRoomCode && Session.getRoomCode());

    // ---- UI refs ----
    const state = {
      room: null,
      players: [],
      me: null,
      unsubPlayers: null,
      isHost: false
    };

    document.addEventListener('DOMContentLoaded', () => {
      if (!roomId) {
        $('#missing').style.display = 'block';
        $('#content').style.display = 'none';
        return;
      }
      $('#rid').textContent = roomId;

      // auth wiring
      $('#login').addEventListener('click', async () => {
        try { await signInWithPopup(auth, new GoogleAuthProvider()); }
        catch (e) { alert(e.code || 'Login failed'); }
      });
      $('#logout').addEventListener('click', async () => { try { await signOut(auth); } catch {} });

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          $('#user').textContent = '(not signed in)';
          $('#login').style.display = 'inline-block';
          $('#logout').style.display = 'none';
          return;
        }
        state.me = user;
        $('#user').textContent = '@' + (user.displayName || user.email || user.uid.slice(0,6));
        $('#login').style.display = 'none';
        $('#logout').style.display = 'inline-block';
        await mount();
      });

      $('#ready').addEventListener('click', toggleReady);
      $('#lock').addEventListener('click', lockAndStart);
    });

    async function mount(){
      // load room
      const rdoc = await getDoc(doc(db, 'rooms', roomId));
      if (!rdoc.exists()) {
        $('#missing').style.display = 'block';
        $('#missing h2').textContent = 'Room not found';
        $('#content').style.display = 'none';
        return;
      }
      state.room = { id: rdoc.id, ...rdoc.data() };
      state.isHost = !!(state.me && state.room.hostUid === state.me.uid);
      $('#vis').textContent   = state.room.visibility || 'friends';
      $('#status').textContent= state.room.status || 'open';
      $('#host').textContent  = state.room.hostUid ? (state.room.hostUid.slice(0,6)+'…') : '(unknown)';
      if (state.room.partyLocked) {
        $('#banner').textContent = 'Party is locked.';
        $('#lock').disabled = true;
      }

      // ensure my player doc exists
      const myRef = doc(db, 'rooms', roomId, 'players', state.me.uid);
      await setDoc(myRef, {
        uid: state.me.uid,
        name: state.me.displayName || state.me.email || state.me.uid,
        ready: false,
        updatedAt: serverTimestamp()
      }, { merge: true });

      // subscribe to players
      if (state.unsubPlayers) try{ state.unsubPlayers(); }catch{}
      state.unsubPlayers = onSnapshot(collection(db, 'rooms', roomId, 'players'), (snap) => {
        state.players = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderPlayers();
      });
    }

    function renderPlayers(){
      const list = $('#players');
      list.innerHTML = '';
      let allReady = state.players.length > 0;
      for (const p of state.players) {
        const div = document.createElement('div');
        div.className = 'player';
        const left = document.createElement('div');
        left.textContent = p.name || p.id;
        const right = document.createElement('div');
        right.textContent = p.ready ? '✅ Ready' : '⏳ Not ready';
        list.appendChild(div);
        div.append(left, right);
        if (!p.ready) allReady = false;
      }
      // ready button label for me
      const meDoc = state.players.find(x => x.id === (state.me && state.me.uid));
      $('#ready').textContent = (meDoc && meDoc.ready) ? 'Unready' : 'Ready';
      // host can lock when all ready
      $('#lock').disabled = !(state.isHost && allReady && !state.room.partyLocked);
    }

    async function toggleReady(){
      if (!state.me) return;
      const myRef = doc(db, 'rooms', roomId, 'players', state.me.uid);
      const cur = state.players.find(x => x.id === state.me.uid);
      const next = !(cur && cur.ready);
      try {
        await setDoc(myRef, { ready: next, updatedAt: serverTimestamp() }, { merge: true });
      } catch (e) { alert('Could not update ready.'); }
    }

    async function lockAndStart(){
      if (!state.isHost) return;
      const partyUids = state.players.map(p => p.id);
      try {
        await updateDoc(doc(db, 'rooms', roomId), {
          partyLocked: true,
          partyUids,
          status: 'locked',
          updatedAt: serverTimestamp()
        });
        $('#banner').textContent = 'Party locked — starting run…';
        // Route to your run/map screen
        const target = 'run.html?roomId=' + roomId;
        if (window.Router && Router.to) Router.to(target);
        else location.href = target;
      } catch (e) { alert('Could not lock/start.'); }
    }
  </script>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Party Select</h1>
        <div class="muted">Room <span id="rid">…</span> • <span id="vis">…</span> • <span id="status">…</span></div>
      </div>
      <div class="row">
        <span id="user" class="pill">(not signed in)</span>
        <button id="login" class="btn">Login with Google</button>
        <button id="logout" class="btn" style="display:none;">Logout</button>
      </div>
    </header>

    <section id="missing" class="card" style="display:none;">
      <h2>No room selected</h2>
      <p class="muted">This page expects a <code>?roomId=XYZ</code> param or an ID saved by your Session code.</p>
      <p><a href="mainmenu.html" class="btn">Back to Main Menu</a></p>
    </section>

    <section id="content" class="grid">
      <div id="banner" class="muted"></div>
      <div class="card">
        <h3 style="margin-top:0">Players</h3>
        <div id="players" class="players"></div>
        <div class="row" style="margin-top:12px;">
          <button id="ready" class="btn">Ready</button>
          <button id="lock"  class="btn primary" disabled>Lock party & start</button>
          <span class="note">Host can start when everyone is Ready.</span>
        </div>
      </div>
    </section>
  </div>
</body>
</html>
