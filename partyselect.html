<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ElemenTails â€” Party Select</title>
  <style>
    :root{ --bg:#0b0c10; --panel:#121520; --muted:#9aa4b2; --accent:#20c997; --radius:14px; }
    html,body{height:100%;margin:0;background:var(--bg);color:#e9eef5;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{margin:0;font-size:26px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer;background:#1e2433;color:#fff}
    .btn.primary{background:var(--accent);color:#06241e}
    .card{background:var(--panel);padding:18px;border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.35);}
    .muted{color:#9aa4b2}
    .row{display:flex;gap:10px;align-items:center}
    ul{list-style:none;padding:0;margin:0;display:grid;gap:6px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#1e2433}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
      collection, onSnapshot, serverTimestamp,
      arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBaIjbM7dVNjKE7CJXPQOievhkiIF17rds",
      authDomain: "elementails.firebaseapp.com",
      projectId: "elementails",
      storageBucket: "elementails.firebasestorage.app",
      messagingSenderId: "497100635124",
      appId: "1:497100635124:web:aeeb25ead96b84751e57a1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // helpers
    const $ = (sel) => document.querySelector(sel);
    const clean = (obj) => Object.fromEntries(Object.entries(obj || {}).filter(([,v]) => v !== undefined));

    const params = new URLSearchParams(location.search);
    const roomId = params.get('roomId');

    let me = null;
    let unsubRoom = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = 'mainmenu.html'; return; }
      me = user;

      // mark presence as PartySelect
      try { await setDoc(doc(db,'presence', me.uid), clean({ online:true, screen:'PartySelect', updatedAt: serverTimestamp() }), { merge:true }); } catch {}

      mount();
    });

    function setText(id, value){ const el = document.getElementById(id); if (el) el.textContent = value; }

    async function mount(){
      if (!roomId) { location.href='mainmenu.html'; return; }
      // ensure I'm in participants
      try {
        await updateDoc(doc(db,'rooms', roomId), clean({
          updatedAt: serverTimestamp(),
          participantUids: arrayUnion(me.uid),
          partyUids: arrayUnion(me.uid)  // auto-join party on landing
        }));
      } catch {}

      const backBtn = document.getElementById('btn-back');
      backBtn.addEventListener('click', leaveAndBack);

      const ref = doc(db,'rooms', roomId);
      unsubRoom = onSnapshot(ref, (snap) => {
        if (!snap.exists()) { location.href='mainmenu.html'; return; }
        const r = snap.data();
        setText('rid', roomId.slice(0,6)+'â€¦');
        setText('vis', r.visibility || 'friends');
        setText('status', r.status || 'open');

        const list = document.getElementById('party');
        list.innerHTML = '';
        const party = Array.isArray(r.partyUids) ? r.partyUids : [];
        if (!party.length) list.innerHTML = '<li class="muted">No players yet.</li>';
        for (const uid of party){
          const li = document.createElement('li'); li.textContent = uid === r.hostUid ? `ðŸ‘‘ ${uid}` : uid;
          list.appendChild(li);
        }
      });
    }

    async function leaveAndBack(){
      try {
        const ref = doc(db,'rooms', roomId);
        const snap = await getDoc(ref);
        if (snap.exists()){
          const r = snap.data();
          if (r.hostUid === me.uid) {
            // host closes room so it doesn't look joinable
            await updateDoc(ref, clean({ status:'closed', updatedAt: serverTimestamp() }));
          }
          // leave party
          await updateDoc(ref, clean({ partyUids: arrayRemove(me.uid), updatedAt: serverTimestamp() }));
        }
      } catch {}
      try { await setDoc(doc(db,'presence', me.uid), clean({ online:true, screen:'MainMenu', updatedAt: serverTimestamp() }), { merge:true }); } catch {}
      location.href = 'mainmenu.html';
    }

    window.addEventListener('beforeunload', async () => {
      try {
        const ref = doc(db,'rooms', roomId);
        const snap = await getDoc(ref);
        if (snap.exists()){
          const r = snap.data();
          if (r.hostUid === me.uid) await updateDoc(ref, clean({ status:'closed', updatedAt: serverTimestamp() }));
          await updateDoc(ref, clean({ partyUids: arrayRemove(me.uid), updatedAt: serverTimestamp() }));
        }
      } catch {}
      try { await setDoc(doc(db,'presence', me.uid), clean({ online:true, screen:'MainMenu', updatedAt: serverTimestamp() }), { merge:true }); } catch {}
      try { unsubRoom && unsubRoom(); } catch {}
    });
  </script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Party Select</h1>
      <button id="btn-back" class="btn">Back</button>
    </header>

    <section class="card">
      <div class="muted">Room <span id="rid">â€¦</span> â€¢ <span id="vis">â€¦</span> â€¢ <span id="status">â€¦</span></div>
      <h3 style="margin:12px 0 6px 0;">Party</h3>
      <ul id="party"></ul>
    </section>
  </div>
</body>
</html>
