<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ElemenTails — Party Select</title>
  <style>
    :root{ --bg:#0b0c10; --panel:#121520; --muted:#9aa4b2; --accent:#20c997; --danger:#ef4444; }
    html,body{height:100%;margin:0;background:var(--bg);color:#e9eef5;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;}
    .shell{max-width:1180px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{font-size:22px;font-weight:900}
    .muted{color:var(--muted)}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:800;background:#1e2433;color:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);color:#042a22}
    .btn.danger{background:#2b1e22;color:#fecaca;border:1px solid #7f1d1d}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .badge{padding:4px 8px;border-radius:999px;background:#0f1220;border:1px solid #273148;font-weight:700;font-size:12px}
    .badge.green{background:#0f2a21;border-color:#1c4532;color:#9be4c5}
    .card{background:var(--panel);border-radius:12px;padding:12px;border:1px solid #263149}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .slot{height:140px;border-radius:10px;background:#0f1220;border:1px dashed #2a3147;display:flex;align-items:center;justify-content:center;color:#718096}
    @media (max-width:900px){ .grid{grid-template-columns:repeat(2,1fr)} }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="row">
        <div class="title">Party Select</div>
        <span id="modeBadge" class="badge">Mode</span>
        <span id="lockBadge" class="badge">Unlocked</span>
        <span id="roomBadge" class="badge"></span>
      </div>
      <div class="row">
        <button id="btnToggleMode" class="btn">Switch to Multiplayer</button>
        <button id="btnBack" class="btn">Back</button>
        <button id="btnStart" class="btn primary">Start Run</button>
      </div>
    </header>

    <div class="card muted" style="margin-bottom:10px">
      Pick 4 unique heroes. Toggle between Singleplayer and Multiplayer before you start. Once you press <b>Start Run</b>, the roster is locked and only those players can re-enter this run.
    </div>

    <section class="card">
      <div class="grid">
        <div class="slot">— choose a class —</div>
        <div class="slot">— choose a class —</div>
        <div class="slot">— choose a class —</div>
        <div class="slot">— choose a class —</div>
      </div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, arrayUnion
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBaIjbM7dVNjKE7CJXPQOievhkiIF17rds",
      authDomain: "elementails.firebaseapp.com",
      projectId: "elementails",
      storageBucket: "elementails.firebasestorage.app",
      messagingSenderId: "497100635124",
      appId: "1:497100635124:web:aeeb25ead96b84751e57a1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ----- utils
    const qs = new URLSearchParams(location.search);
    const roomId = qs.get('roomId');
    if (!roomId) {
      alert('Missing room id.');
    }
    const roomRef = doc(db, 'rooms', roomId);
    const $ = (sel) => document.querySelector(sel);

    function setBadge(el, text, cls){
      el.textContent = text;
      el.className = 'badge' + (cls ? ' ' + cls : '');
    }

    // ----- state
    const state = {
      room: null,
      me: null,
    };

    // ----- auth
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        await signInWithPopup(auth, new GoogleAuthProvider());
        return;
      }
      state.me = user;
      boot();
    });

    // ----- boot: subscribe room, enforce locks
    function boot(){
      onSnapshot(roomRef, async (snap) => {
        if (!snap.exists()) { alert('Room not found.'); return; }
        state.room = snap.data();

        // Fill badges
        $('#roomBadge').textContent = 'Room ' + roomId.slice(0,6) + '…';
        const isMulti = (state.room.visibility === 'friends' || state.room.visibility === 'public');
        setBadge($('#modeBadge'), isMulti ? 'Multiplayer' : 'Singleplayer', 'green');
        setBadge($('#lockBadge'), state.room.rosterLocked ? 'Roster Locked' : 'Unlocked');

        // Toggle button label + disabled when locked
        const btnToggle = $('#btnToggleMode');
        btnToggle.textContent = isMulti ? 'Switch to Singleplayer' : 'Switch to Multiplayer';
        btnToggle.disabled = !!state.room.rosterLocked;

        // Start button disabled when already started
        $('#btnStart').disabled = !!state.room.rosterLocked;

        // ---- roster lock enforcement
        if (state.room.rosterLocked) {
          const locked = state.room.lockedPartyUids || [];
          if (!locked.includes(state.me.uid)) {
            alert('This run is locked to its original party.');
            // Soft redirect back to main menu
            location.href = 'mainmenu.html';
            return;
          }
        } else {
          // Before start: ensure user is in participants
          if (!Array.isArray(state.room.participantUids) || !state.room.participantUids.includes(state.me.uid)) {
            try {
              await updateDoc(roomRef, {
                participantUids: arrayUnion(state.me.uid)
              });
            } catch {}
          }
        }
      });
    }

    // ----- UI actions
    $('#btnBack').addEventListener('click', () => history.back());

    $('#btnToggleMode').addEventListener('click', async () => {
      if (!state.room || state.room.rosterLocked) return;
      const isMulti = (state.room.visibility === 'friends' || state.room.visibility === 'public');
      const nextVis = isMulti ? 'private' : 'friends';
      try {
        await updateDoc(roomRef, { visibility: nextVis, updatedAt: serverTimestamp() });
      } catch (e) {
        alert(e.message || e.code || 'Failed to change mode.');
      }
    });

    $('#btnStart').addEventListener('click', async () => {
      if (!state.room) return;
      // Lock the roster to current participants; mark in progress
      const participants = Array.isArray(state.room.participantUids) ? state.room.participantUids : [state.me.uid];
      try {
        await updateDoc(roomRef, {
          rosterLocked: true,
          lockedPartyUids: participants,
          status: 'in_progress',
          startedAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        alert('Run started. Roster locked.');
      } catch (e) {
        alert(e.message || e.code || 'Failed to start run.');
      }
    });
  </script>
</body>
</html>
