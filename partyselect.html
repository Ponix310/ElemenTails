<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ElemenTails — Party Select</title>
  <style>
    :root{
      --bg: #0c0f13;
      --panel: #141922;
      --panel-2: #0f141c;
      --text: #e9eef6;
      --muted: #a9b2c2;
      --accent: #fbbf24;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 16px;
      --gap: 18px;
      --box-border: 2px solid rgba(255,255,255,.06);
      --danger: #ef4444;
      --ok: #22c55e;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      background: radial-gradient(1200px 1200px at 10% 10%, #111927 0%, #0b0f15 60%, #070a0f 100%);
      color: var(--text);
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 20px clamp(16px, 4vw, 40px);
      border-bottom: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(6px);
      position: sticky; top: 0; z-index: 10;
      background: linear-gradient(180deg, rgba(20,25,34,.9), rgba(20,25,34,.65));
    }
    header .title { display: flex; gap: 14px; align-items: baseline; }
    header .title h1 { margin: 0; font-size: clamp(18px, 2.2vw, 26px); letter-spacing: .4px; }
    header .title .sub { color: var(--muted); font-size: clamp(12px, 1.4vw, 14px); }
    header .actions { display: flex; gap: 10px; }
    .btn {
      appearance: none; background: #1b2431; border: 1px solid rgba(255,255,255,.08);
      color: var(--text); padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600;
      box-shadow: var(--shadow); text-decoration: none;
    }
    .btn.primary { background: linear-gradient(180deg, #1e293b, #1b2431); border-color: rgba(250,204,21,.25); }
    .btn.primary:focus-visible { box-shadow: 0 0 0 3px rgba(251,191,36,.35); }
    .page { padding: 16px clamp(16px, 4vw, 40px) 40px; max-width: 1500px; margin: 0 auto; }

    .modeNotice{
      margin: 8px 0 18px;
      padding: 10px 14px;
      border-radius: 12px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      display: flex; align-items: center; gap: 10px;
      font-size: 14px; color: var(--muted);
    }
    .pill{ padding: 2px 8px; border-radius: 999px; font-weight: 700; font-size: 12px; border: 1px solid rgba(255,255,255,.12); }
    .pill.ok{ background: rgba(34,197,94,.15); color: #bbf7d0; border-color: rgba(34,197,94,.25); }
    .pill.no{ background: rgba(239,68,68,.12); color: #fecaca; border-color: rgba(239,68,68,.25); }

    /* GRID */
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-auto-rows: auto; gap: var(--gap); }
    .col-name { text-align: center; font-weight: 800; font-size: clamp(16px, 1.8vw, 22px); letter-spacing: .3px; padding: 6px 0 2px; color: var(--text); text-shadow: 0 2px 14px rgba(0,0,0,.6); }

    .frame {
      position: relative; overflow: hidden; border-radius: var(--radius);
      background: linear-gradient(160deg, var(--panel), var(--panel-2));
      border: var(--box-border); box-shadow: var(--shadow);
      min-height: 160px; display: flex; align-items: center; justify-content: center; isolation: isolate;
    }
    .frame.large { min-height: clamp(160px, 18vw, 240px); }
    .frame.icon  { min-height: clamp(90px, 10vw, 130px); padding: 8px; cursor: pointer; }
    .frame.option { min-height: clamp(140px, 16vw, 220px); }
    .frame img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .frame.icon img { width: auto; height: 80%; object-fit: contain; padding: 6px; filter: drop-shadow(0 4px 18px rgba(0,0,0,.35)); }
    .inactive .overlay { position: absolute; inset: 0; background: linear-gradient(180deg, rgba(10,14,20,.55), rgba(10,14,20,.85)); z-index: 2; pointer-events: none; }
    .inactive img { filter: grayscale(1) brightness(.7) contrast(.9); }
    .label-top { position: absolute; top: 8px; left: 10px; background: rgba(0,0,0,.45); border: 1px solid rgba(255,255,255,.12); color: var(--text); padding: 4px 8px; border-radius: 8px; font-size: 12px; z-index: 3; }
    .lockTag{ position:absolute; bottom:8px; right:10px; font-size:12px; opacity:.8; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.12); padding:3px 6px; border-radius:8px; }

    .hint { text-align:center; color: var(--muted); font-size: 13px; margin-top: 6px; grid-column: 1/-1; }

    /* Modal chooser */
    .modal-backdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      display: none; align-items: center; justify-content: center;
      z-index: 50;
    }
    .modal{
      width: min(720px, 92vw);
      background: #121821;
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .modal h3{ margin: 0 0 10px; font-size: 18px; }
    .choice-grid{
      display:grid; grid-template-columns: repeat(4,1fr); gap: 12px;
    }
    .choice{
      background: linear-gradient(160deg, var(--panel), var(--panel-2));
      border: var(--box-border);
      border-radius: 12px; padding: 10px; text-align:center; cursor: pointer;
      position: relative; overflow: hidden; min-height: 110px;
    }
    .choice img{ width: 100%; height: 70px; object-fit: contain; display:block; filter: drop-shadow(0 4px 14px rgba(0,0,0,.35)); }
    .choice .name{ display:block; margin-top: 6px; font-weight: 700; font-size: 13px; }
    .choice.taken{ opacity:.45; filter: grayscale(1); cursor: not-allowed; }
    .modal .row{ display:flex; justify-content:flex-end; gap:10px; margin-top: 12px; }
    .hidden{ display:none !important; }

    @media (max-width: 980px) { .grid { grid-template-columns: repeat(2, 1fr); } .choice-grid{ grid-template-columns: repeat(2,1fr);} }
    @media (max-width: 560px) { header .actions { display: none; } .grid { grid-template-columns: 1fr; } .choice-grid{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <h1>Party Select</h1>
      <span class="sub">Uses images from <code>/images/class-portraits</code> and <code>/images/weapons</code></span>
    </div>
    <div class="actions">
      <a class="btn" href="mainmenu.html">Back</a>
      <a id="startBtn" class="btn primary" href="game.html">Start Run</a>
    </div>
  </header>

  <main class="page">
    <div id="modeNotice" class="modeNotice">
      <span id="modePill" class="pill">Mode</span>
      <span id="modeText">Loading…</span>
    </div>

    <!-- Column titles -->
    <section class="grid" id="names-row" aria-label="player-names"></section>

    <!-- Row 1: Large hero portraits -->
    <section class="grid" id="row-hero" aria-label="hero-portraits"></section>

    <!-- Row 2: Weapon / class icons -->
    <section class="grid" id="row-icon" aria-label="weapon-icons"></section>

    <!-- Optional note -->
    <div class="hint">Click a player’s icon tile to choose from the 4 drawn weapons.</div>

    <!-- Row 3 & 4: Placeholder "option" rows (faded) -->
    <section class="grid" id="row-opt-a" aria-label="option-row-a"></section>
    <section class="grid" id="row-opt-b" aria-label="option-row-b"></section>
  </main>

  <!-- Modal chooser -->
  <div id="chooser" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3 id="chooserTitle">Choose a class</h3>
      <div id="choiceGrid" class="choice-grid"></div>
      <div class="row">
        <button id="closeChooser" class="btn">Cancel</button>
      </div>
    </div>
  </div>

  <script>
  // ---- Utility helpers ------------------------------------------------------
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
  const el = (tag, cls) => { const n = document.createElement(tag); if (cls) n.className = cls; return n; };
  const img = (src, alt='') => { const i = new Image(); i.src = src; i.alt = alt; return i; };
  const shuffle = (arr) => arr.map(v => [Math.random(), v]).sort((a,b)=>a[0]-b[0]).map(([,v])=>v);

  // ---- Resolve mode: Single vs Multiplayer (no new rules) -------------------
  function resolveMode(){
    const url = new URL(window.location.href);
    const qp = (url.searchParams.get('mode') || '').toLowerCase();
    // Try multiple keys so it works with your main menu without renaming
    const lsGameMode = (localStorage.getItem('gameMode') || '').toLowerCase();
    const lsMode = (localStorage.getItem('mode') || '').toLowerCase();
    const isMultiFlag = (localStorage.getItem('isMultiplayer') || localStorage.getItem('multiplayer') || '')
                        .toString().toLowerCase();
    if (qp === 'single' || qp === 'sp') return 'single';
    if (qp === 'multi' || qp === 'mp' || qp === 'multiplayer') return 'multi';
    if (lsGameMode === 'single') return 'single';
    if (lsGameMode === 'multi' || lsGameMode === 'multiplayer') return 'multi';
    if (lsMode === 'single') return 'single';
    if (lsMode === 'multi' || lsMode === 'multiplayer') return 'multi';
    if (['1','true','yes'].includes(isMultiFlag)) return 'multi';
    return 'single'; // safe default
  }

  // ---- Data (filenames can be adjusted to match repo) -----------------------
  const HEROES = [
    { name: "Ponix",  hero: "images/class-portraits/monk.png" },
    { name: "Dikken", hero: "images/class-portraits/assassin.png" },
    { name: "Ponix",  hero: "images/class-portraits/wizard.png" },
    { name: "Chewni", hero: "images/class-portraits/warrior.png" },
  ];

  // Catalog for the 4 weapon/class icons shown in your mock
  const WEAPONS = [
    { id: "bow",           name: "Bow",            icon: "images/weapons/bow.png" },
    { id: "daggers",       name: "Daggers",        icon: "images/weapons/daggers.png" },
    { id: "greataxe",      name: "Greataxe",       icon: "images/weapons/greataxe.png" },
    { id: "katana",        name: "Katana",         icon: "images/weapons/katana.png" },
    { id: "knuckles",      name: "Knuckles",       icon: "images/weapons/knuckles.png" },
    { id: "spear",         name: "Spear",          icon: "images/weapons/spear.png" },
    { id: "staff",         name: "Staff",          icon: "images/weapons/staff.png" },
    { id: "sword-shield",  name: "Sword & Shield", icon: "images/weapons/sword-shield.png" },
    { id: "tome",          name: "Tome",           icon: "images/weapons/tome.png" },
  ];

  // ---- State ----------------------------------------------------------------
  const state = {
    mode: resolveMode(),           // 'single' | 'multi'
    drawn: [],                     // 4 randomly drawn weapons (ids)
    takenByPlayer: [null, null, null, null],  // weapon id per player or null
  };

  function drawWeapons(){
    // Draw 4 at random without replacement (matches your "4 weapons drawn")
    state.drawn = shuffle(WEAPONS).slice(0, 4).map(w => w.id);
  }

  function weaponById(id){ return WEAPONS.find(w => w.id === id); }
  function isWeaponAvailable(id){
    const isInDrawn = state.drawn.includes(id);
    const isTaken = state.takenByPlayer.includes(id);
    return isInDrawn && !isTaken;
  }

  // ---- Render grids ---------------------------------------------------------
  function renderGrids(){
    const rows = {
      names: $('#names-row'),
      hero:  $('#row-hero'),
      icon:  $('#row-icon'),
      optA:  $('#row-opt-a'),
      optB:  $('#row-opt-b'),
    };
    for (const k in rows) rows[k].innerHTML = '';

    const single = state.mode === 'single';
    // Column setup
    HEROES.forEach((h, idx) => {
      // Name row
      const name = el('div', 'col-name');
      name.textContent = h.name || `Player ${idx+1}`;
      rows.names.appendChild(name);

      // Hero image
      const hero = el('div', 'frame large');
      hero.appendChild(img(h.hero, `${h.name} — hero`));
      // Lock other columns if in Single Player
      if (single && idx > 0) {
        hero.classList.add('inactive');
        hero.appendChild(el('div','overlay'));
        const lock = el('div','lockTag'); lock.textContent = 'Locked (Single Player)';
        hero.appendChild(lock);
      }
      rows.hero.appendChild(hero);

      // Icon tile (click to choose)
      const icon = el('div', 'frame icon');
      const chosenId = state.takenByPlayer[idx];
      if (chosenId){
        const w = weaponById(chosenId);
        icon.appendChild(img(w.icon, `${h.name} — ${w.name}`));
      } else {
        // Placeholder miniature "?" with subtle text
        const p = el('div');
        p.style.opacity = .65;
        p.style.fontSize = '13px';
        p.textContent = `${h.name} — icon`;
        icon.appendChild(p);
      }
      if (single && idx > 0) {
        icon.classList.add('inactive');
        icon.appendChild(el('div','overlay'));
        const lock = el('div','lockTag'); lock.textContent = 'Locked';
        icon.appendChild(lock);
      } else {
        icon.addEventListener('click', () => openChooser(idx));
        icon.title = 'Click to choose class';
      }
      rows.icon.appendChild(icon);

      // Option rows (faded like the mock)
      for (const r of ['optA','optB']){
        const box = el('div', 'frame option inactive');
        box.appendChild(el('div','overlay'));
        const t = el('div'); t.style.opacity = .45; t.style.fontSize = '13px';
        t.textContent = `${h.name} — option ${r === 'optA' ? 'A' : 'B'}`;
        box.appendChild(t);
        rows[r].appendChild(box);
      }
    });
  }

  // ---- Mode notice ----------------------------------------------------------
  function renderModeBanner(){
    const pill = $('#modePill');
    const text = $('#modeText');
    if (state.mode === 'single'){
      pill.textContent = 'Single Player';
      pill.classList.add('no');
      text.textContent = 'Lobby locked — friends cannot join this run.';
    } else {
      pill.textContent = 'Multiplayer';
      pill.classList.add('ok');
      text.textContent = 'Friends may join until all 4 slots are filled.';
    }
  }

  // ---- Chooser modal --------------------------------------------------------
  let chooserPlayerIndex = null;

  function openChooser(playerIdx){
    chooserPlayerIndex = playerIdx;
    const bg = $('#chooser');
    const grid = $('#choiceGrid');
    grid.innerHTML = '';
    // Show the 4 drawn weapons, greying out those already taken
    state.drawn.forEach(id => {
      const w = weaponById(id);
      const cell = el('div', 'choice' + (isWeaponAvailable(id) ? '' : ' taken'));
      cell.appendChild(img(w.icon, w.name));
      const nm = el('span', 'name'); nm.textContent = w.name; cell.appendChild(nm);
      if (isWeaponAvailable(id)){
        cell.addEventListener('click', () => chooseWeaponForPlayer(playerIdx, id));
      }
      grid.appendChild(cell);
    });
    $('#chooserTitle').textContent = `Choose a class for Player ${playerIdx+1}`;
    bg.style.display = 'flex';
    bg.setAttribute('aria-hidden','false');
  }
  function closeChooser(){
    const bg = $('#chooser');
    bg.style.display = 'none';
    bg.setAttribute('aria-hidden','true');
    chooserPlayerIndex = null;
  }
  $('#closeChooser').addEventListener('click', closeChooser);
  $('#chooser').addEventListener('click', (e)=>{ if(e.target.id==='chooser') closeChooser(); });

  function chooseWeaponForPlayer(playerIdx, weaponId){
    // If this player already had a weapon, release it
    const prev = state.takenByPlayer[playerIdx];
    if (prev && prev !== weaponId){
      // releasing simply means it'll be available again since we only block by taken list
    }
    // Prevent duplicates by removing the weapon from others
    state.takenByPlayer = state.takenByPlayer.map((w,i)=> i===playerIdx ? weaponId : (w===weaponId ? null : w));
    closeChooser();
    persist();
    renderGrids();
  }

  // ---- Persistence (localStorage) -------------------------------------------
  const LS_KEY = 'ET_partyselect_v1';
  function persist(){
    const data = { mode: state.mode, drawn: state.drawn, takenByPlayer: state.takenByPlayer };
    localStorage.setItem(LS_KEY, JSON.stringify(data));
  }
  function restore(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return false;
      const data = JSON.parse(raw);
      if (Array.isArray(data.drawn) && Array.isArray(data.takenByPlayer) && (data.mode==='single' || data.mode==='multi')){
        state.mode = data.mode;
        state.drawn = data.drawn;
        state.takenByPlayer = data.takenByPlayer;
        return true;
      }
    }catch(_){}
    return false;
  }

  // ---- Init -----------------------------------------------------------------
  (function init(){
    if (!restore()){
      drawWeapons();
      persist();
    }
    renderModeBanner();
    renderGrids();
  })();
  </script>
</body>
</html>
