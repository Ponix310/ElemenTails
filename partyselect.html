<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ElemenTails — Party Select</title>
  <style>
    :root{
      --panel: #141922;
      --panel-2: #0f141c;
      --text: #e9eef6;
      --muted: #a9b2c2;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 16px;
      --gap: 18px;
      --box-border: 2px solid rgba(255,255,255,.06);
      --accent: #fbbf24;
      --ok: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      background: radial-gradient(1200px 1200px at 10% 10%, #111927 0%, #0b0f15 60%, #070a0f 100%);
      color: var(--text);
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 20px clamp(16px, 4vw, 40px);
      border-bottom: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(6px);
      position: sticky; top: 0; z-index: 10;
      background: linear-gradient(180deg, rgba(20,25,34,.9), rgba(20,25,34,.65));
    }
    header .title { display: flex; gap: 14px; align-items: baseline; }
    header .title h1 { margin: 0; font-size: clamp(18px, 2.2vw, 26px); letter-spacing: .4px; }
    header .title .sub { color: var(--muted); font-size: clamp(12px, 1.4vw, 14px); }
    header .actions { display: flex; gap: 10px; }
    .btn {
      appearance: none; background: #1b2431; border: 1px solid rgba(255,255,255,.08);
      color: var(--text); padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600;
      box-shadow: var(--shadow); text-decoration: none;
      transition: transform .06s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: linear-gradient(180deg, #1e293b, #1b2431); border-color: rgba(250,204,21,.25); }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }
    .page { padding: 16px clamp(16px, 4vw, 40px) 40px; max-width: 1500px; margin: 0 auto; }

    .modeNotice{
      margin: 8px 0 18px; padding: 10px 14px; border-radius: 12px;
      background: rgba(255,255,255,.03); border: 1px solid rgba(255,255,255,.08);
      display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--muted);
    }
    .pill{ padding: 2px 8px; border-radius: 999px; font-weight: 700; font-size: 12px; border: 1px solid rgba(255,255,255,.12); }
    .pill.ok{ background: rgba(34,197,94,.15); color: #bbf7d0; border-color: rgba(34,197,94,.25); }
    .pill.warn{ background: rgba(245,158,11,.18); color: #fde68a; border-color: rgba(245,158,11,.25); }

    .grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-auto-rows: auto; gap: var(--gap); }
    .col-name { text-align: center; font-weight: 800; font-size: clamp(16px, 1.8vw, 22px); letter-spacing: .3px; padding: 6px 0 2px; color: var(--text); text-shadow: 0 2px 14px rgba(0,0,0,.6); }

    .frame {
      position: relative; overflow: hidden; border-radius: var(--radius);
      background: linear-gradient(160deg, var(--panel), var(--panel-2));
      border: var(--box-border); box-shadow: var(--shadow);
      min-height: 160px; display: flex; align-items: center; justify-content: center; isolation: isolate;
    }
    .frame.large { min-height: clamp(160px, 18vw, 240px); }
    .frame.icon  { min-height: clamp(90px, 10vw, 130px); padding: 8px; cursor: pointer; }
    .frame.option { min-height: clamp(140px, 16vw, 220px); }
    .frame img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .frame.icon img { width: auto; height: 80%; object-fit: contain; padding: 6px; filter: drop-shadow(0 4px 18px rgba(0,0,0,.35)); }
    .label-top { position: absolute; top: 8px; left: 10px; background: rgba(0,0,0,.45); border: 1px solid rgba(255,255,255,.12); color: var(--text); padding: 4px 8px; border-radius: 8px; font-size: 12px; z-index: 3; }

    .hint { text-align:center; color: var(--muted); font-size: 13px; margin-top: 6px; grid-column: 1/-1; }

    /* Modal */
    .modal-backdrop{
      position: fixed; inset: 0; background: rgba(0,0,0,.55);
      display: none; align-items: center; justify-content: center; z-index: 50;
    }
    .modal{ width: min(820px, 94vw); background: #121821; border: 1px solid rgba(255,255,255,.1);
      border-radius: 16px; box-shadow: var(--shadow); padding: 16px; }
    .modal h3{ margin: 0 0 10px; font-size: 18px; }
    .choice-grid{ display:grid; grid-template-columns: repeat(4,1fr); gap: 12px; }
    .choice{
      background: linear-gradient(160deg, var(--panel), var(--panel-2));
      border: var(--box-border); border-radius: 12px; padding: 10px; text-align:center; cursor: pointer;
      position: relative; overflow: hidden; min-height: 160px;
    }
    .choice img{ width: 100%; height: 110px; object-fit: contain; display:block; filter: drop-shadow(0 4px 14px rgba(0,0,0,.35)); }
    .choice .name{ display:block; margin-top: 6px; font-weight: 700; font-size: 13px; }
    .choice.taken{ opacity:.45; filter: grayscale(1); cursor: not-allowed; }
    .modal .row{ display:flex; justify-content:flex-end; gap:10px; margin-top: 12px; }
    .hidden{ display:none !important; }

    @media (max-width: 980px) { .grid { grid-template-columns: repeat(2, 1fr); } .choice-grid{ grid-template-columns: repeat(2,1fr);} }
    @media (max-width: 560px) { header .actions { display: none; } .grid { grid-template-columns: 1fr; } .choice-grid{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <h1>Party Select</h1>
      <span class="sub">4 unique heroes required. Classes limited to the 4 drawn weapons.</span>
    </div>
    <div class="actions">
      <a class="btn" href="mainmenu.html">Back</a>
      <a id="startBtn" class="btn primary" href="game.html" disabled>Start Run</a>
    </div>
  </header>

  <main class="page">
    <div id="modeNotice" class="modeNotice">
      <span id="modePill" class="pill">Mode</span>
      <span id="modeText">Loading…</span>
    </div>

    <!-- Column titles (dynamic names or Slot 1..4) -->
    <section class="grid" id="names-row" aria-label="player-names"></section>

    <!-- Row 1: Class portraits (updates when a class is chosen) -->
    <section class="grid" id="row-hero" aria-label="class-portraits"></section>

    <!-- Row 2: Weapon icons (shows chosen weapon for each slot; click to choose) -->
    <section class="grid" id="row-icon" aria-label="weapon-icons"></section>

    <!-- Optional note -->
    <div class="hint">Click a slot’s icon to choose a class. In Single Player, you’ll fill all 4 slots yourself.</div>

    <!-- Row 3 & 4: Placeholder "option" rows for future features -->
    <section class="grid" id="row-opt-a" aria-label="option-row-a"></section>
    <section class="grid" id="row-opt-b" aria-label="option-row-b"></section>
  </main>

  <!-- Modal chooser -->
  <div id="chooser" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3 id="chooserTitle">Choose a class</h3>
      <div id="choiceGrid" class="choice-grid"></div>
      <div class="row">
        <button id="closeChooser" class="btn">Cancel</button>
      </div>
    </div>
  </div>

  <script>
  // ---------- Helper utilities
  const $ = (sel, el=document) => el.querySelector(sel);
  const el = (tag, cls) => { const n = document.createElement(tag); if (cls) n.className = cls; return n; };
  const img = (src, alt='') => { const i = new Image(); i.src = src; i.alt = alt; return i; };
  const shuffle = (arr) => arr.map(v => [Math.random(), v]).sort((a,b)=>a[0]-b[0]).map(([,v])=>v);

  // ---------- URL/Room
  const URL_QS = new URLSearchParams(location.search);
  const ROOM_ID = URL_QS.get('roomId') || null;
  const LS_KEY  = `ET_ps_v2:${ROOM_ID || 'standalone'}`;

  // ---------- Mode & players (banner only; do not persist mode)
  function resolveMode(){
    const url = new URL(window.location.href);
    const qp = (url.searchParams.get('mode') || '').toLowerCase();
    if (['single','sp'].includes(qp)) return 'single';
    if (['multi','mp','multiplayer'].includes(qp)) return 'multi';
    const et = (localStorage.getItem('ET_mode') || '').toLowerCase();
    if (['multi','multiplayer','friends','public'].includes(et)) return 'multi';
    if (['single','sp','solo','private'].includes(et)) return 'single';
    return 'single';
  }
  function resolveNames(){
    try{
      const arr = JSON.parse(localStorage.getItem('ET_players') || '[]');
      if (Array.isArray(arr) && arr.length){
        const labels = [];
        for (let i=0;i<4;i++) labels.push(arr[i] || `Slot ${i+1}`);
        return labels;
      }
    }catch(_){}
    return ['Slot 1','Slot 2','Slot 3','Slot 4'];
  }

  // ---------- Assets (canonical filenames)
  const WEAPONS = [
    { id: 'bow',          name: 'Bow',           icon: 'images/weapons/bow.png' },
    { id: 'daggers',      name: 'Daggers',       icon: 'images/weapons/daggers.png' },
    { id: 'greataxe',     name: 'Greataxe',      icon: 'images/weapons/greataxe.png' },
    { id: 'katana',       name: 'Katana',        icon: 'images/weapons/katana.png' },
    { id: 'knuckles',     name: 'Knuckles',      icon: 'images/weapons/knuckles.png' },
    { id: 'spear',        name: 'Spear',         icon: 'images/weapons/spear.png' },
    { id: 'staff',        name: 'Staff',         icon: 'images/weapons/staff.png' },
    { id: 'sword-shield', name: 'Sword & Shield',icon: 'images/weapons/sword-shield.png' },
    { id: 'tome',         name: 'Tome',          icon: 'images/weapons/tome.png' },
  ];
  const CLASSES = [
    { id:'archer',     name:'Archer',     hero:'raven',  weapon:'bow',          portrait:'images/class-portraits/archer.png' },
    { id:'assassin',   name:'Assassin',   hero:'fox',    weapon:'daggers',      portrait:'images/class-portraits/assassin.png' },
    { id:'barbearian', name:'Barbearian', hero:'bear',   weapon:'greataxe',     portrait:'images/class-portraits/barbearian.png' },
    { id:'bard',       name:'Bard',       hero:'rabbit', weapon:'bow',          portrait:'images/class-portraits/bard.png' },
    { id:'battlemage', name:'Battlemage', hero:'raven',  weapon:'katana',       portrait:'images/class-portraits/battlemage.png' },
    { id:'berserker',  name:'Berserker',  hero:'frog',   weapon:'knuckles',     portrait:'images/class-portraits/berserker.png' },
    { id:'cleric',     name:'Cleric',     hero:'rabbit', weapon:'tome',         portrait:'images/class-portraits/cleric.png' },
    { id:'druid',      name:'Druid',      hero:'rabbit', weapon:'staff',        portrait:'images/class-portraits/druid.png' },
    { id:'lancer',     name:'Lancer',     hero:'bear',   weapon:'spear',        portrait:'images/class-portraits/lancer.png' },
    { id:'monk',       name:'Monk',       hero:'fox',    weapon:'knuckles',     portrait:'images/class-portraits/monk.png' },
    { id:'myrmidon',   name:'Myrmidon',   hero:'frog',   weapon:'spear',        portrait:'images/class-portraits/myrmidon.png' },
    { id:'ninja',      name:'Ninja',      hero:'wolf',   weapon:'daggers',      portrait:'images/class-portraits/ninja.png' },
    { id:'paladin',    name:'Paladin',    hero:'wolf',   weapon:'sword-shield', portrait:'images/class-portraits/paladin.png' },
    { id:'reaper',     name:'Reaper',     hero:'raven',  weapon:'greataxe',     portrait:'images/class-portraits/reaper.png' },
    { id:'samurai',    name:'Samurai',    hero:'wolf',   weapon:'katana',       portrait:'images/class-portraits/samurai.png' },
    { id:'summoner',   name:'Summoner',   hero:'fox',    weapon:'tome',         portrait:'images/class-portraits/summoner.png' },
    { id:'warrior',    name:'Warrior',    hero:'bear',   weapon:'sword-shield', portrait:'images/class-portraits/warrior.png' },
    { id:'wizard',     name:'Wizard',     hero:'frog',   weapon:'staff',        portrait:'images/class-portraits/wizard.png' },
  ];

  // ---------- State (mode is NOT persisted)
  const state = {
    mode: 'single',                    // banner only
    names: resolveNames(),             // 4 labels
    drawn: [],                         // 4 weapon ids
    slots: [null, null, null, null],   // class ids by slot
  };

  function persist(){
    const payload = { names: state.names, drawn: state.drawn, slots: state.slots };
    localStorage.setItem(LS_KEY, JSON.stringify(payload));
  }
  function restore(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return false;
      const d = JSON.parse(raw);
      if (!d) return false;
      state.names = Array.isArray(d.names) && d.names.length===4 ? d.names : state.names;
      state.drawn = Array.isArray(d.drawn) ? d.drawn : state.drawn;
      state.slots = Array.isArray(d.slots) && d.slots.length===4 ? d.slots : state.slots;
      return true;
    }catch(_){ return false; }
  }

  function drawWeapons(){
    state.drawn = shuffle([...WEAPONS]).slice(0,4).map(w=>w.id);
  }
  function weaponById(id){ return WEAPONS.find(w=>w.id===id); }
  function classById(id){ return CLASSES.find(c=>c.id===id); }
  function heroTaken(hero){ return state.slots.some(cid => cid && classById(cid)?.hero === hero); }
  function allowedClasses(){ return CLASSES.filter(c => state.drawn.includes(c.weapon) && !heroTaken(c.hero)); }

  // ---------- Render
  function renderBanner(){
    const pill = $('#modePill'); const text = $('#modeText');
    if (state.mode === 'multi'){
      pill.textContent = 'Multiplayer'; pill.className = 'pill ok';
      text.textContent = 'Friends may join until all 4 slots are filled.';
    } else {
      pill.textContent = 'Single Player'; pill.className = 'pill warn';
      text.textContent = 'Lobby locked to other players. You will fill all 4 slots.';
    }
  }
  function renderButtons(){
    const start = $('#startBtn');
    const ready = state.slots.every(Boolean);
    start.disabled = !ready;
    start.title = ready ? '' : 'Choose 4 classes to begin';
  }
  function render(){
    renderBanner();
    const rows = {
      names: $('#names-row'),
      hero:  $('#row-hero'),
      icon:  $('#row-icon'),
      optA:  $('#row-opt-a'),
      optB:  $('#row-opt-b'),
    };
    for (const k in rows) rows[k].innerHTML = '';

    for (let i=0;i<4;i++){
      // names
      const nm = el('div','col-name'); nm.textContent = state.names[i]; rows.names.appendChild(nm);

      // portrait
      const heroBox = el('div','frame large');
      const cid = state.slots[i];
      if (cid){
        const c = classById(cid);
        heroBox.appendChild(img(c.portrait, c.name));
        const tag = el('div','label-top'); tag.textContent = c.name; heroBox.appendChild(tag);
      } else {
        const ph = el('div'); ph.style.opacity=.5; ph.style.fontSize='14px'; ph.textContent='— choose a class —'; heroBox.appendChild(ph);
      }
      rows.hero.appendChild(heroBox);

      // icon clicker
      const icon = el('div','frame icon');
      if (cid){
        const w = weaponById(classById(cid).weapon);
        icon.appendChild(img(w.icon, w.name));
        icon.title = 'Change class';
      } else {
        const t = el('div'); t.style.opacity=.65; t.style.fontSize='13px'; t.textContent='Click to choose'; icon.appendChild(t);
        icon.title = 'Choose class';
      }
      icon.addEventListener('click', () => openChooser(i));
      rows.icon.appendChild(icon);

      // faded placeholders
      for (const r of ['optA','optB']){
        const box = el('div','frame option'); rows[r].appendChild(box);
      }
    }
    renderButtons();
  }

  // ---------- Modal
  let choosingIndex = null;
  function openChooser(idx){
    choosingIndex = idx;
    const options = allowedClasses();
    const bg = $('#chooser'); const grid = $('#choiceGrid');
    grid.innerHTML='';

    $('#chooserTitle').textContent = `Choose a class (Weapons drawn: ${state.drawn.map(w=>weaponById(w).name).join(', ')})`;

    // Allowed classes (clickable)
    options.forEach(c => {
      const cell = el('div','choice'); cell.appendChild(img(c.portrait,c.name));
      const nm = el('span','name'); nm.textContent = `${c.name} — ${weaponById(c.weapon).name}`; cell.appendChild(nm);
      cell.addEventListener('click', () => { state.slots[choosingIndex] = c.id; persist(); closeChooser(); render(); });
      grid.appendChild(cell);
    });

    // Disallowed (shown greyed for clarity)
    CLASSES.filter(c => !options.includes(c)).forEach(c => {
      const cell = el('div','choice taken'); cell.appendChild(img(c.portrait,c.name));
      const nm = el('span','name'); nm.textContent = c.name; cell.appendChild(nm);
      grid.appendChild(cell);
    });

    bg.style.display='flex'; bg.setAttribute('aria-hidden','false');
  }
  function closeChooser(){ const bg=$('#chooser'); bg.style.display='none'; bg.setAttribute('aria-hidden','true'); choosingIndex=null; }
  $('#closeChooser').addEventListener('click', closeChooser);
  $('#chooser').addEventListener('click', e=>{ if(e.target.id==='chooser') closeChooser(); });

  // ---------- Init
  (function init(){
    // Always resolve mode fresh on entry
    state.mode = resolveMode();

    // Try to restore for THIS roomId; if nothing, draw fresh weapons
    if (!restore()){ drawWeapons(); persist(); }

    render();
  })();
  </script>
</body>
</html>
