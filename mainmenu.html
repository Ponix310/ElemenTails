<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ElemenTails — Main Menu</title>
  <style>
    :root{
      --bg:#0b0c10; --panel:#121520; --muted:#9aa4b2; --accent:#20c997; --radius:14px;
      --chip:#0f172a; --chipText:#cbd5e1;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#e9eef5;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px;display:grid;grid-template-columns:1fr 360px;gap:16px}
    @media (max-width:1200px){ .wrap{grid-template-columns:1fr} .right{order:-1} }
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;grid-column:1/-1}
    h1{margin:0;font-size:28px}
    .auth{display:flex;gap:10px;align-items:center;color:#cbd5e1}
    .pill{background:#0f1220;border:1px solid #2a3147;border-radius:999px;padding:6px 10px;font-size:14px}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer;background:#1e2433;color:#fff;box-shadow:0 2px 0 rgba(0,0,0,.25) inset}
    .btn:hover{filter:brightness(1.06)}
    .btn.primary{background:var(--accent);color:#06241e}
    .btn.success{background:#1db954;color:#06241e}
    .btn.ghost{background:#1e2433;color:#cbd5e1}
    .btn.small{padding:8px 10px;border-radius:10px;font-weight:700}
    .btn[disabled]{opacity:.55;cursor:not-allowed;filter:none}
    .card{background:var(--panel);padding:18px;border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.35);}
    .grid{display:grid;gap:12px}
    .muted{color:#9aa4b2;font-size:12px}

    .profileHeader{position:relative;border-radius:16px;overflow:hidden;background:#0f1220;border:1px solid #2a3147}
    .profileHeader .bg{width:100%;height:240px;background-size:cover;background-position:center}
    .profileHeader .name{position:absolute;left:14px;bottom:12px;font-weight:900;font-size:18px;
      padding:6px 10px;border-radius:999px;background:rgba(5,10,20,.7);backdrop-filter:blur(2px);}
    .profileHeader .edit{position:absolute;right:12px;bottom:12px}

    .friendTile{position:relative;border-radius:14px;overflow:hidden;border:1px solid #2a3147;background:#0f1220}
    .friendTile .bg{width:100%;height:220px;background-size:cover;background-position:center;opacity:0.96}
    .friendTile .label{position:absolute;left:14px;bottom:12px;font-weight:800;background:rgba(8,12,20,.75);padding:6px 10px;border-radius:999px}
    .chip{position:absolute;right:12px;bottom:12px;display:inline-flex;align-items:center;gap:8px;background:var(--chip);color:var(--chipText);padding:6px 10px;border-radius:999px;border:1px solid #273148}
    .dot{width:8px;height:8px;border-radius:999px;background:#64748b}
    .dot.online{background:#22c55e}

    .row{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .slots{display:grid;grid-template-columns:1fr;gap:10px}
    .slot{display:flex;align-items:center;justify-content:space-between;border:1px solid #2a3147;background:#0f1220;border-radius:10px;padding:12px}
    .slot .left{display:flex;flex-direction:column}
    .slot .title{font-weight:800}

    .field{display:flex;gap:8px}
    .input{flex:1;background:#0f1220;border:1px solid #2a3147;border-radius:12px;padding:10px 12px;color:#e2e8f0;outline:none}
    .input:focus{border-color:#35508f}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px}
    .modal.open{display:flex}
    .modal .panel{background:#0f1220;border:1px solid #2a3147;border-radius:16px;max-width:860px;width:100%;padding:18px}
    .avatarGrid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:10px}
    .avatar{aspect-ratio:16/10;border-radius:12px;background:#121826;border:1px solid #2a3147;background-size:cover;background-position:center;cursor:pointer}
    .avatar.selected{outline:2px solid var(--accent)}
  </style>
</head>
<body>
  <header class="wrap">
    <div>
      <h1>ElemenTails</h1>
      <div class="muted">Create a session, edit your profile, and invite friends.</div>
    </div>
    <div class="auth">
      <span id="auth-username" class="pill" style="display:none;"></span>
      <button id="auth-login" class="btn">Login with Google</button>
      <button id="auth-logout" class="btn" style="display:none;">Logout</button>
    </div>
  </header>

  <main class="wrap">
    <section class="left">
      <div class="profileHeader card">
        <div id="myProfileBg" class="bg"></div>
        <div id="myHandle" class="name">@User</div>
        <button id="btnEditProfile" class="btn small edit">Edit Profile</button>
      </div>

      <section class="card" style="margin-top:12px">
        <div class="row">
          <h3 style="margin:0;font-size:16px">Friends</h3>
          <div class="field" style="flex:1;margin-left:12px">
            <input id="friendSearch" class="input" placeholder="Enter username"/>
            <button id="btnAddFriend" class="btn small">Add</button>
          </div>
        </div>
        <div id="friends-list" class="grid" style="margin-top:12px"></div>
      </section>
    </section>

    <aside class="right">
      <section class="card">
        <h3 style="margin:0 0 8px;font-size:16px">Your Save Slots</h3>
        <div id="slots-header" class="muted" style="margin-bottom:10px;">Save Slots — 0/5 used</div>
        <div id="slots-wrap" class="slots"></div>
      </section>
    </aside>
  </main>

  <div id="profileModal" class="modal">
    <div class="panel">
      <h3 style="margin:0 0 8px;font-size:18px">Edit Profile</h3>
      <div class="muted">Letters only (A–Z), length 3–20. We’ll auto‑capitalize.</div>
      <div class="field" style="margin-top:10px">
        <input id="usernameInput" class="input" placeholder="Username"/>
        <button id="btnSaveProfile" class="btn">Save</button>
        <button id="btnCloseProfile" class="btn ghost">Close</button>
      </div>
      <div class="muted" style="margin-top:10px">Pick an avatar:</div>
      <div id="avatarGrid" class="avatarGrid"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, collection, serverTimestamp,
      writeBatch, getDocs, query, onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBaIjbM7dVNjKE7CJXPQOievhkiIF17rds",
      authDomain: "elementails.firebaseapp.com",
      projectId: "elementails",
      storageBucket: "elementails.firebasestorage.app",
      messagingSenderId: "497100635124",
      appId: "1:497100635124:web:aeeb25ead96b84751e57a1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const SLOT_IDS = ["slot1","slot2","slot3","slot4","slot5"];

    const PORTRAITS = [
      'archer','assassin','barbarian','bard','battlemage','berserker','cleric',
      'druid','lancer','monk','myrmidon','ninja','paladin','reaper','samurai',
      'summoner','warrior','wizard'
    ];
    const PORTRAIT_PATH = 'images/class-portraits/';
    const FALLBACK = PORTRAIT_PATH + 'monk.png';

    function portraitUrl(name){ return PORTRAIT_PATH + name + '.png'; }

    // NEW: letters only, 3–20
    const unameLettersOnly = /^[A-Za-z]{3,20}$/;
    const toDisplay = s => s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
    const toLower = s => s.toLowerCase();

    function slotRef(uid, slotId){ return doc(db, `users/${uid}/slots/${slotId}`); }
    function routeToPartySelect(roomId, mode){
      try { localStorage.setItem('ET_mode', (mode==='friends'?'multi':'single')); } catch {}
      window.location.href = `partyselect.html?roomId=${encodeURIComponent(roomId)}`;
    }
    function clearLocalForRoom(roomId){
      try{ ['v2','v3','v4'].forEach(v => localStorage.removeItem(`ET_ps_${v}:${roomId}`)); }catch{}
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('auth-login').addEventListener('click', async () => {
        try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch(e){ alert(e.code||'Login failed'); }
      });
      document.getElementById('auth-logout').addEventListener('click', async () => { try { await signOut(auth); } catch {} });
      document.getElementById('btnEditProfile').addEventListener('click', () => toggleModal(true));
      document.getElementById('btnCloseProfile').addEventListener('click', () => toggleModal(false));
      document.getElementById('btnSaveProfile').addEventListener('click', saveProfile);
      document.getElementById('btnAddFriend').addEventListener('click', addFriendByUsername);

      // Build avatar grid
      const grid = document.getElementById('avatarGrid');
      PORTRAITS.forEach(name => {
        const d = document.createElement('div');
        d.className = 'avatar';
        d.style.backgroundImage = `url('${portraitUrl(name)}')`;
        d.title = name;
        d.addEventListener('click', () => {
          [...grid.children].forEach(n => n.classList.remove('selected'));
          d.classList.add('selected');
          grid.dataset.selectedName = name;
        });
        grid.appendChild(d);
      });

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          document.getElementById('auth-username').style.display='inline-block';
          document.getElementById('auth-login').style.display='none';
          document.getElementById('auth-logout').style.display='inline-block';
          await loadMyProfile();
          refreshFriends();
          refreshSlots();
        } else {
          document.getElementById('auth-username').style.display='none';
          document.getElementById('auth-login').style.display='inline-block';
          document.getElementById('auth-logout').style.display='none';
        }
      });
    });

    async function loadMyProfile(){
      const me = auth.currentUser; if(!me) return;
      const snap = await getDoc(doc(db,'publicProfiles', me.uid));
      let display = 'User';
      let lower = 'user';
      let avatarName = 'monk';
      if (snap.exists()){
        const d = snap.data();
        display = d.usernameDisplay || toDisplay(d.usernameLower||'user');
        lower = d.usernameLower || 'user';
        if (PORTRAITS.includes(d.avatarName)) avatarName = d.avatarName;
      }
      document.getElementById('auth-username').textContent = '@' + display;
      document.getElementById('myHandle').textContent = '@' + display;
      document.getElementById('myProfileBg').style.backgroundImage = `url('${portraitUrl(avatarName)}')`;
      document.getElementById('profileModal').dataset.currentAvatar = avatarName;
      document.getElementById('usernameInput').value = display;
    }

    function toggleModal(open){
      const m = document.getElementById('profileModal');
      m.classList.toggle('open', !!open);
      if (open){
        const current = m.dataset.currentAvatar || 'monk';
        const grid = document.getElementById('avatarGrid');
        [...grid.children].forEach(n => n.classList.remove('selected'));
        const idx = PORTRAITS.indexOf(current);
        if (idx>=0) grid.children[idx].classList.add('selected');
        grid.dataset.selectedName = current;
      }
    }

    async function saveProfile(){
      const me = auth.currentUser; if(!me) return;
      const raw = (document.getElementById('usernameInput').value || '').trim();
      // Validate letters-only and length
      if (!unameLettersOnly.test(raw)){
        alert('Invalid username. Letters A–Z only, 3–20 chars.'); return;
      }
      const lower = toLower(raw);
      const display = toDisplay(raw);
      const avatarName = document.getElementById('avatarGrid').dataset.selectedName || 'monk';
      if (!PORTRAITS.includes(avatarName)){ alert('Pick an avatar.'); return; }

      const profRef = doc(db,'publicProfiles', me.uid);
      const curr = await getDoc(profRef);
      const oldLower = curr.exists() && curr.data().usernameLower ? curr.data().usernameLower : null;

      // Check availability if changing
      if (!oldLower || oldLower !== lower){
        const claim = await getDoc(doc(db,'usernames', lower));
        if (claim.exists() && claim.data().uid !== me.uid){
          alert('That username is taken.'); return;
        }
      }

      const batch = writeBatch(db);
      batch.set(profRef, {
        usernameLower: lower,
        usernameDisplay: display,
        avatarName,
        updatedAt: serverTimestamp(),
      }, { merge: true });
      batch.set(doc(db,'usernames', lower), { uid: me.uid });
      if (oldLower && oldLower !== lower) {
        batch.set(doc(db,'usernames', oldLower), { uid: null }); // optional soft release
      }
      try{
        await batch.commit();
        toggleModal(false);
        await loadMyProfile();
      }catch(e){
        alert(e.message || e.code || 'Failed to save profile.');
      }
    }

    async function addFriendByUsername(){
      const me = auth.currentUser; if(!me) return;
      const input = document.getElementById('friendSearch');
      const raw = (input.value || '').trim();
      if (!unameLettersOnly.test(raw)){ alert('Enter a valid username (letters only, 3–20).'); return; }
      const lower = toLower(raw);
      const claim = await getDoc(doc(db,'usernames', lower));
      if (!claim.exists()){ alert('User not found.'); return; }
      const uid = claim.data().uid;
      if (uid === me.uid){ alert('You cannot add yourself.'); return; }
      await setDoc(doc(db,`users/${me.uid}/friends/${uid}`), { uid, addedAt: serverTimestamp() }, { merge: true });
      input.value='';
      await refreshFriends();
    }

    async function refreshFriends(){
      const me = auth.currentUser; if(!me) return;
      const list = document.getElementById('friends-list');
      list.innerHTML = '';
      try{
        const ss = await getDocs(query(collection(db, `users/${me.uid}/friends`)));
        if (ss.empty){ list.innerHTML = '<div class="muted">(No friends yet)</div>'; return; }

        for (const ds of ss.docs){
          const fuid = ds.id;
          const pSnap = await getDoc(doc(db,'publicProfiles', fuid));
          const pd = pSnap.exists() ? pSnap.data() : {};
          const display = pd.usernameDisplay || toDisplay(pd.usernameLower||'user');
          const avatarName = PORTRAITS.includes(pd.avatarName) ? pd.avatarName : 'rogue';
          const tile = document.createElement('div'); tile.className='friendTile';
          const bg = document.createElement('div'); bg.className='bg'; bg.style.backgroundImage = `url('${portraitUrl(avatarName)}')`;
          const label = document.createElement('div'); label.className='label'; label.textContent = display;
          const chip = document.createElement('div'); chip.className='chip'; chip.innerHTML = '<span class="dot"></span><span>Offline</span>';
          const dot = chip.querySelector('.dot'); const txt = chip.querySelector('span + span');
          onSnapshot(doc(db,'presence', fuid), (snap)=>{
            const online = snap.exists() && !!snap.data().online;
            dot.className = online ? 'dot online' : 'dot';
            txt.textContent = online ? 'Online' : 'Offline';
          });
          tile.appendChild(bg); tile.appendChild(label); tile.appendChild(chip);
          list.appendChild(tile);
        }
      }catch(e){
        list.innerHTML = `<div class="muted">Could not load friends: ${e.message||e.code}</div>`;
      }
    }

    async function refreshSlots(){
      const me = auth.currentUser; if(!me) return;
      const wrap = document.getElementById('slots-wrap'); wrap.innerHTML='';

      const entries = [];
      for (const id of SLOT_IDS){
        const sSnap = await getDoc(slotRef(me.uid, id));
        const s = sSnap.exists() ? sSnap.data() : {};
        let room = null;
        if (s?.roomId){
          const rSnap = await getDoc(doc(db, 'rooms', s.roomId));
          if (rSnap.exists()) room = { id: rSnap.id, ...rSnap.data() };
          else room = { id: s.roomId, missing: true };
        }
        entries.push({ id, slot: s, room });
      }
      const used = entries.filter(e => e.slot?.roomId).length;
      document.getElementById('slots-header').textContent = `Save Slots — ${used}/5 used`;
      entries.forEach(e => renderSlotRow(wrap, e));
    }

    function renderSlotRow(wrap, e){
      const row = document.createElement('div');
      row.className = 'slot';
      const left = document.createElement('div'); left.className='left';
      const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px';

      if (e.room){
        left.innerHTML = `<div class="title">Slot ${e.id.slice(4)} — Room ${e.room.id.slice(0,6)}…</div>
                          <div class="muted">${e.room.missing ? '(Missing room doc)' : `Status: ${e.room.status || 'open'} · Visibility: ${e.room.visibility || 'friends'}`}</div>`;
        const loadBtn = document.createElement('button'); loadBtn.className='btn small'; loadBtn.textContent='Load';
        loadBtn.onclick = ()=> routeToPartySelect(e.room.id, e.room.visibility || 'friends');
        const delBtn = document.createElement('button'); delBtn.className='btn ghost small'; delBtn.textContent='Delete';
        delBtn.onclick = ()=> deleteSlotRoom(e.id, e.room.id);
        right.appendChild(loadBtn); right.appendChild(delBtn);
      } else {
        left.innerHTML = `<div class="title">Slot ${e.id.slice(4)} — Empty</div>
                          <div class="muted">Create a new run here.</div>`;
        const mkSolo = document.createElement('button'); mkSolo.className='btn small primary'; mkSolo.textContent='Create Singleplayer';
        mkSolo.onclick = ()=> createInSlot(e.id, 'private');
        const mkMulti = document.createElement('button'); mkMulti.className='btn small success'; mkMulti.textContent='Create Multiplayer';
        mkMulti.onclick = ()=> createInSlot(e.id, 'friends');
        right.appendChild(mkSolo); right.appendChild(mkMulti);
      }
      row.appendChild(left); row.appendChild(right);
      wrap.appendChild(row);
    }

    async function createInSlot(slotId, visibility){
      const me = auth.currentUser; if(!me){ alert('Sign in first.'); return; }
      const sSnap = await getDoc(slotRef(me.uid, slotId));
      if (sSnap.exists() && sSnap.data()?.roomId){
        alert('That slot is no longer empty. Choose another or delete first.'); return;
      }
      const batch = writeBatch(db);
      const roomRef = doc(collection(db,'rooms'));
      batch.set(roomRef, {
        hostUid: me.uid,
        slotId,
        visibility,
        status: 'open',
        mode: visibility === 'private' ? 'solo' : 'multiplayer',
        partyLocked:false,
        maxParty:4,
        participantUids:[me.uid],
        partyUids:[me.uid],
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      });
      batch.set(slotRef(me.uid, slotId), {
        roomId: roomRef.id,
        visibility,
        createdAt: serverTimestamp(),
      }, { merge: true });
      try{
        await batch.commit();
        routeToPartySelect(roomRef.id, visibility);
      }catch(e){
        alert(e.message || e.code || 'Could not create session.'); await refreshSlots();
      }
    }

    async function deleteSlotRoom(slotId, roomId){
      const me = auth.currentUser; if(!me){ alert('Sign in first.'); return; }
      if (!confirm('Delete this save? This cannot be undone.')) return;
      const batch = writeBatch(db);
      batch.delete(doc(db, 'rooms', roomId));
      batch.set(slotRef(me.uid, slotId), { roomId: null, deletedAt: serverTimestamp() }, { merge: true });
      try{
        await batch.commit();
        clearLocalForRoom(roomId); await refreshSlots();
      }catch(e){
        alert(e.message || e.code || 'Failed to delete save.');
      }
    }
  </script>
</body>
</html>
