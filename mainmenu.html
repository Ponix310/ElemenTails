<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ElemenTails â€” Main Menu</title>
  <!-- Main Menu v7: friend tile = full background image; single presence button; conditional session button; remove extra pill -->

  <style>
    :root{ --bg:#0b0c10; --panel:#121520; --muted:#9aa4b2; --accent:#20c997; --radius:14px; }
    html,body{height:100%;margin:0;background:var(--bg);color:#e9eef5;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;}
    .wrap{max-width:1180px;margin:32px auto;padding:0 16px;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{margin:0;font-size:28px}
    .auth{display:flex;gap:10px;align-items:center;color:#cbd5e1}
    .pill{background:#0f1220;border:1px solid #2a3147;border-radius:999px;padding:6px 10px;font-size:14px}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;background:#1e2433;color:#fff}
    .btn:hover{filter:brightness(1.08)}
    .btn.primary{background:var(--accent);color:#06241e}
    .btn.ghost{background:#1e2433;color:#cbd5e1}
    .btn[disabled]{opacity:.55;cursor:not-allowed;filter:none}
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:10px;padding:0}
    .card{background:var(--panel);padding:18px;border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.35);}
    .grid{display:grid;gap:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{display:block;font-size:13px;margin-bottom:6px;color:#9aa4b2}
    select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3147;background:#0f1320;color:#fff}
    .muted{color:#9aa4b2;font-size:12px}
    .columns{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:1100px){ .columns{grid-template-columns:1fr} }

    /* Right rail: profile banner at top, friends vertical under it */
    .right-rail{display:grid;gap:16px}
    .banner-card{position:relative;aspect-ratio:3/2;border-radius:14px;overflow:hidden;border:1px solid #2a3147;box-shadow:0 8px 24px rgba(0,0,0,.35);}
    .banner-bg{position:absolute;inset:0;background-size:cover;background-position:center;opacity:1;filter:saturate(1.05) contrast(1.05);}
    .banner-body{position:relative;padding:14px;display:flex;justify-content:space-between;align-items:flex-end;height:100%;}
    .banner-title{font-weight:800;font-size:20px;text-shadow:0 1px 2px rgba(0,0,0,.6)}

    /* Vertical friends list */
    .friends-col{display:grid;gap:10px}
    .friend-tile{
      position:relative; display:flex; align-items:flex-end; gap:10px;
      border:1px solid #2a3147; border-radius:12px; padding:12px;
      background:#0f1220; overflow:hidden; min-height:110px; aspect-ratio:3/1.8;
    }
    .friend-bg{position:absolute; inset:0; background-size:cover; background-position:center; opacity:1;}
    .friend-overlay{position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.55));}
    .friend-content{position:relative; z-index:1; width:100%; display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .friend-name{font-weight:800; font-size:16px; text-shadow:0 1px 2px rgba(0,0,0,.6)}
    .friend-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .status-btn{padding:8px 10px;border-radius:8px;border:0;background:#1e2433;color:#fff;cursor:pointer;font-weight:700;min-width:128px;text-align:center}
    .status-join{background:var(--accent);color:#06241e}
    .status-disabled{background:#1e2433;color:#cbd5e1;cursor:not-allowed;opacity:.9}
  </style>

  <!-- Firebase v12 (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, deleteDoc, collection, query, orderBy, onSnapshot, serverTimestamp,
      where, getDocs, addDoc, limit
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBaIjbM7dVNjKE7CJXPQOievhkiIF17rds",
      authDomain: "elementails.firebaseapp.com",
      projectId: "elementails",
      storageBucket: "elementails.firebasestorage.app",
      messagingSenderId: "497100635124",
      appId: "1:497100635124:web:aeeb25ead96b84751e57a1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const portraitUrl = key => `images/class-portraits/${key}.png`;

    // ---------- Auth UI ----------
    document.addEventListener('DOMContentLoaded', () => {
      const loginBtn = document.getElementById('auth-login');
      const logoutBtn = document.getElementById('auth-logout');
      const namePill = document.getElementById('auth-username');

      loginBtn.addEventListener('click', async () => {
        try { await signInWithPopup(auth, new GoogleAuthProvider()); }
        catch (e) { alert(e.code || 'Login failed'); }
      });
      logoutBtn.addEventListener('click', async () => { try { await signOut(auth); } catch {} });

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          let display = user.displayName || '(user)';
          try {
            const uDoc = await getDoc(doc(db, 'users', user.uid));
            if (uDoc.exists() && uDoc.data().username) display = uDoc.data().username;
          } catch {}
          namePill.textContent = '@' + display;
          namePill.style.display = 'inline-block';
          loginBtn.style.display = 'none';
          logoutBtn.style.display = 'inline-block';
          await upsertPresence('MainMenu');  // mark me online on Main Menu
          renderMyBanner();
          refreshFriends();
        } else {
          namePill.style.display = 'none';
          loginBtn.style.display = 'inline-block';
          logoutBtn.style.display = 'none';
          document.getElementById('friends-col').innerHTML = '<div class="muted">(sign in to see friends)</div>';
        }
      });
    });

    // ---------- Create Session ----------
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('create-session-btn')?.addEventListener('click', onCreateSession);
      document.getElementById('btn-single')?.addEventListener('click', ()=> createSession('private'));
      document.getElementById('btn-multi')?.addEventListener('click', ()=> createSession('public'));
      document.getElementById('btn-load')?.addEventListener('click', toggleLoadList);
    
      document.getElementById('et-friend-add').addEventListener('click', onAdd);
      document.getElementById('et-friend-input').addEventListener('keydown', e => { if(e.key==='Enter') onAdd(); });
      document.getElementById('edit-profile-btn').addEventListener('click', () => {
        if (window.Router && Router.to) Router.to('profile.html');
        else location.href = 'profile.html';
      });

      // presence freshness
      document.addEventListener('visibilitychange', () => {
        const me = auth.currentUser; if(!me) return;
        if (document.visibilityState === 'visible') upsertPresence('MainMenu');
      });
      window.addEventListener('beforeunload', async () => {
        const me = auth.currentUser; if(!me) return;
        try {
          await setDoc(doc(db,'presence', me.uid), { online:false, lastOnline: serverTimestamp() }, { merge:true });
        } catch {}
      });
    });

    async function onCreateSession(){
      // legacy create button kept for compatibility (uses dropdown if present)
    
      const me = auth.currentUser; if(!me){ alert('Sign in first.'); return; }
      const visibility = document.getElementById('session-visibility').value;
      try {
        const ref = await addDoc(collection(db, 'rooms'), {
          hostUid: me.uid, visibility, status: 'open', mode:'multiplayer',
          partyLocked:false, participantUids:[me.uid], partyUids:[],
          createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        });
        if (window.Session && Session.setRoomCode) Session.setRoomCode(ref.id);
        if (window.Router && Router.to) Router.to('lobby.html?roomId=' + ref.id);
        else location.href = 'lobby.html?roomId=' + ref.id;
      } catch (e) { alert('Could not create session.'); }
    }

    function setStatus(msg){
      const el = document.getElementById('et-friends-status');
      el.textContent = msg || '';
      el.className = 'muted';
    }

    
    // ---------- Create Session (Single/Multiplayer) ----------
    async function createSession(visibility){
      const me = auth.currentUser; if(!me){ alert('Sign in first.'); return; }
      try {
        const ref = await addDoc(collection(db, 'rooms'), {
          hostUid: me.uid, visibility, status: 'open', mode: (visibility==='private' ? 'solo' : 'multiplayer'),
          partyLocked:false, participantUids:[me.uid], partyUids:[],
          createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        });
        if (window.Session && Session.setRoomCode) Session.setRoomCode(ref.id);
        if (window.Router && Router.to) Router.to('lobby.html?roomId=' + ref.id);
        else location.href = 'lobby.html?roomId=' + ref.id;
      } catch (e) { alert('Could not create session.'); }
    }

    function toggleLoadList(){
      const panel = document.getElementById('load-list');
      if (!panel) return;
      const showing = panel.style.display !== 'none';
      panel.style.display = showing ? 'none' : 'block';
      if (!showing) loadHostedSessions(); // populate when opening
    }

    async function loadHostedSessions(){
      const me = auth.currentUser; if(!me){ return; }
      const wrap = document.getElementById('load-items'); if(!wrap) return;
      wrap.innerHTML = '';
      try {
        const qy = query(collection(db,'rooms'),
                         where('hostUid','==', me.uid),
                         orderBy('createdAt','desc'),
                         limit(25));
        const ss = await getDocs(qy);
        if (ss.empty){
          wrap.innerHTML = '<div class="muted">(No saves found)</div>';
          return;
        }
        ss.forEach(docSnap => {
          const r = docSnap.data(); r.id = docSnap.id;
          const row = document.createElement('div');
          row.style.cssText = 'display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px solid #2a3147;background:#0f1220;border-radius:10px;padding:10px';
          const left = document.createElement('div');
          const when = r.createdAt?.toDate ? r.createdAt.toDate().toLocaleString() : '[unknown time]';
          left.innerHTML = `<div style="font-weight:700">Room ${r.id.slice(0,6)}â€¦</div>
                            <div class="muted">Status: ${r.status||'open'} Â· Visibility: ${r.visibility||'friends'} Â· ${when}</div>`;
          const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px';

          const loadBtn = document.createElement('button'); loadBtn.className='btn'; loadBtn.textContent='Load';
          loadBtn.onclick = () => {
            if (window.Session && Session.setRoomCode) Session.setRoomCode(r.id);
            if (window.Router && Router.to) Router.to('lobby.html?roomId=' + r.id);
            else location.href = 'lobby.html?roomId=' + r.id;
          };

          const delBtn = document.createElement('button'); delBtn.className='btn ghost icon-btn'; delBtn.title='Delete save';
          delBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>`;
          delBtn.onclick = async () => {
            if (!confirm('Delete this save? This cannot be undone.')) return;
            try{
              await deleteDoc(doc(db,'rooms', r.id));
              row.remove();
            }catch{ alert('Failed to delete save.'); }
          };

          right.appendChild(loadBtn);
          right.appendChild(delBtn);
          row.appendChild(left);
          row.appendChild(right);
          wrap.appendChild(row);
        });
      } catch (e) {
        wrap.innerHTML = '<div class="muted">Could not load your saves.</div>';
      }
    }

    // ---------- Presence helpers ----------
    
    async function upsertPresence(screen){
      const me = auth.currentUser; if(!me) return;
      try {
        await setDoc(doc(db,'presence', me.uid), { online:true, screen, updatedAt: serverTimestamp() }, { merge:true });
      } catch {}
    }

    async function readPresence(uid){
      try {
        const p = await getDoc(doc(db,'presence', uid));
        if (!p.exists()) return { online:false };
        const data = p.data() || {};
        return { online: !!data.online, screen: data.screen || null, updatedAt: data.updatedAt || null };
      } catch {
        return { online:false };
      }
    }

    // ---------- Banner ----------
    function fallbackGradient(uid){
      let h=0; for (let i=0;i<uid.length;i++) h=(h*31+uid.charCodeAt(i))>>>0;
      const a = h%360, b=(h>>8)%360;
      return `linear-gradient(135deg, hsl(${a} 45% 18%), hsl(${b} 45% 22%))`;
    }

    async function renderMyBanner(){
      const me = auth.currentUser; if(!me) return;
      const title = document.getElementById('banner-title');
      const bg = document.getElementById('banner-bg');
      title.textContent = document.getElementById('auth-username').textContent || '@Player';
      try {
        const p = await getDoc(doc(db,'publicProfiles', me.uid));
        const key = (p.exists() && p.data().portrait) ? p.data().portrait : null;
        if (key) bg.style.backgroundImage = `url('${portraitUrl(key)}')`;
        else bg.style.background = fallbackGradient(me.uid);
      } catch { bg.style.background = fallbackGradient(me.uid); }
    }

    // ---------- Friends list ----------
    async function onAdd(){
      const me = auth.currentUser; if(!me){ setStatus('Sign in first.'); return; }
      const v = (document.getElementById('et-friend-input').value || '').trim();
      if(!v){ setStatus('Type a username.'); return; }
      const uLower = v.toLowerCase();
      try{
        const claim = await getDoc(doc(db, 'usernames', uLower));
        if(!claim.exists()){ setStatus('User not found.'); return; }
        const friendUid = claim.data() && claim.data().uid;
        if(!friendUid){ setStatus('User not found.'); return; }
        if(friendUid === me.uid){ setStatus('Thatâ€™s you ðŸ™‚'); return; }
        const myRef = doc(db, 'users', me.uid, 'friends', friendUid);
        const exists = await getDoc(myRef);
        if(exists.exists()){ setStatus('Already in your friends.'); return; }
        await setDoc(myRef, { uid: friendUid, username: v, usernameLower: uLower, addedAt: serverTimestamp() });
        document.getElementById('et-friend-input').value='';
        setStatus('Friend added âœ”');
      }catch(e){ setStatus('Could not add friend.'); }
    }

    async function fetchPortrait(uid){
      try{ const p = await getDoc(doc(db,'publicProfiles', uid)); if (p.exists() && p.data().portrait) return p.data().portrait; }
      catch{}
      return null;
    }

    function renderFriendRow(container, friend, me){
      const row = document.createElement('div'); row.className='friend-tile';

      // background image
      const bg = document.createElement('div'); bg.className='friend-bg';
      const overlay = document.createElement('div'); overlay.className='friend-overlay';
      row.appendChild(bg); row.appendChild(overlay);

      // content
      const content = document.createElement('div'); content.className='friend-content';
      const name = document.createElement('div'); name.className='friend-name'; name.textContent = friend.username || friend.usernameLower || friend.id;
      const right = document.createElement('div'); right.className='friend-actions';

      // presence button
      const presenceBtn = document.createElement('button'); presenceBtn.className='status-btn status-disabled'; presenceBtn.textContent='Checkingâ€¦'; presenceBtn.disabled=true;

      // remove icon
      const rm = document.createElement('button'); rm.className='btn ghost icon-btn'; rm.title='Remove';
      rm.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="9"></circle>
        <line x1="6.5" y1="6.5" x2="17.5" y2="17.5"></line>
      </svg>`;
      rm.onclick = async () => {
        try{ await deleteDoc(doc(db, 'users', me.uid, 'friends', friend.id)); setStatus('Removed.'); }
        catch{ setStatus('Could not remove.'); }
      };

      right.appendChild(presenceBtn);
      // session button will be inserted conditionally before rm
      right.appendChild(rm);
      content.appendChild(name); content.appendChild(right);
      row.appendChild(content);
      container.appendChild(row);

      (async () => {
        const key = await fetchPortrait(friend.id);
        if (key) bg.style.backgroundImage = `url('${portraitUrl(key)}')`;
        else bg.style.background = fallbackGradient(friend.id);
      })();

      // Determine status & render session button only when needed
      (async () => {
        try {
          const presence = await readPresence(friend.id);
          presenceBtn.textContent = presence.online ? 'Online' : 'Offline';
          presenceBtn.className = 'status-btn status-disabled';
          presenceBtn.disabled = true;

          // Rooms check
          const q1 = query(collection(db,'rooms'), where('participantUids','array-contains', friend.id), orderBy('createdAt','desc'), limit(5));
          const ss = await getDocs(q1);
          let latest=null, joinable=null;
          ss.forEach(d=>{
            const r = d.data(); r.id=d.id;
            if (!latest) latest=r;
            if (r.visibility==='private') return;
            if (r.partyLocked){
              const party = Array.isArray(r.partyUids)?r.partyUids:[];
              if (!party.includes(me.uid)) return;
            }
            if (!joinable) joinable=r;
          });

          const isRunning = (room) => room && (room.status==='running' || room.status==='inGame');
          const isPartySelect = (room) => room && (room.status==='party' || room.status==='lobby' || room.status==='open');
          const partyCount = (room) => Array.isArray(room?.partyUids) ? room.partyUids.length : 0;
          const includesMe = (room) => Array.isArray(room?.partyUids) ? room.partyUids.includes(me.uid) : false;

          function ensureSessionBtn(label, enabled, onClick){
            const sessionBtn = document.createElement('button');
            sessionBtn.className = enabled ? 'status-btn status-join' : 'status-btn status-disabled';
            sessionBtn.textContent = label;
            sessionBtn.disabled = !enabled;
            if (enabled && typeof onClick === 'function') sessionBtn.onclick = onClick;
            right.insertBefore(sessionBtn, rm);
          }

          if (joinable) {
            if (isRunning(joinable)) {
              if (includesMe(joinable)) {
                ensureSessionBtn('Rejoin Game', true, () => {
                  if (window.Session && Session.setRoomCode) Session.setRoomCode(joinable.id);
                  if (window.Router && Router.to) Router.to('lobby.html?roomId='+joinable.id);
                  else location.href = 'lobby.html?roomId='+joinable.id;
                });
              } else {
                ensureSessionBtn('In Game', false);
              }
            } else if (isPartySelect(joinable)) {
              const roomHasRoom = partyCount(joinable) < 4 && !joinable.partyLocked;
              ensureSessionBtn('In Party Select', roomHasRoom, () => {
                if (window.Session && Session.setRoomCode) Session.setRoomCode(joinable.id);
                if (window.Router && Router.to) Router.to('lobby.html?roomId='+joinable.id);
                else location.href = 'lobby.html?roomId='+joinable.id;
              });
            } else {
              ensureSessionBtn('In Game', false);
            }
          } else if (latest && isRunning(latest)) {
            if (includesMe(latest)) {
              ensureSessionBtn('Rejoin Game', true, () => {
                if (window.Session && Session.setRoomCode) Session.setRoomCode(latest.id);
                if (window.Router && Router.to) Router.to('lobby.html?roomId='+latest.id);
                else location.href = 'lobby.html?roomId='+latest.id;
              });
            } else {
              ensureSessionBtn('In Game', false);
            }
          }
        } catch (e) {
          presenceBtn.textContent = 'Offline';
          presenceBtn.className = 'status-btn status-disabled';
        }
      })();
    }

    let unsub=null;
    function refreshFriends(){
      if (unsub) try{unsub();}catch{}
      const me = auth.currentUser; if(!me) return;
      const list = document.getElementById('friends-col');
      const q = query(collection(db,'users', me.uid, 'friends'), orderBy('usernameLower'));
      unsub = onSnapshot(q, (snap)=>{
        list.innerHTML = '';
        const items = snap.docs.map(d=>({id:d.id, ...d.data()}));
        if(!items.length) list.innerHTML = '<div class="muted">(no friends yet)</div>';
        items.forEach(it => renderFriendRow(list, it, me));
      }, ()=> setStatus('Could not load friends.'));
    }
  </script>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Elemen Tails</h1>
        <div class="muted">Create a session and invite friends.</div>
      </div>
      <div class="auth">
        <span id="auth-username" class="pill" style="display:none;"></span>
        <button id="auth-login" class="btn">Login with Google</button>
        <button id="auth-logout" class="btn" style="display:none;">Logout</button>
      </div>
    </header>

    <div class="columns">
      <!-- LEFT: Create Session -->
      
      <section class="card grid" id="left-actions">
        <div class="row" style="gap:12px">
          <button id="btn-single" class="btn primary" style="flex:1;min-width:220px;">Create Singleplayer Game</button>
          <button id="btn-multi" class="btn" style="flex:1;min-width:220px;background:#1db954;color:#06241e;">Create Multiplayer Game</button>
        </div>

        <div class="row" style="gap:12px">
          <button id="btn-load" class="btn ghost" style="flex:1;min-width:220px;">Load Game</button>
        </div>

        <div id="load-list" class="grid" style="display:none;gap:8px">
          <div class="muted">Your previously hosted sessions:</div>
          <div id="load-items" class="grid" style="gap:8px"></div>
        </div>
      </section>
    

      <!-- RIGHT rail: My banner then Friends vertical -->
      <section class="right-rail">
        <div id="banner-card" class="banner-card">
          <div id="banner-bg" class="banner-bg"></div>
          <div class="banner-body">
            <div>
              <div id="banner-title" class="banner-title">@Player</div>
              <div class="muted">Your public profile banner</div>
            </div>
            <button id="edit-profile-btn" class="btn">Edit Profile</button>
          </div>
        </div>

        <div class="card">
          <h2 style="margin:0 0 10px 0;font-size:18px">Friends</h2>
          <div class="row" style="gap:8px;align-items:center;margin-bottom:8px">
            <input id="et-friend-input" type="text" placeholder="Enter username" style="flex:1;padding:10px 12px;border-radius:10px;border:1px solid #2a3147;background:#0f1320;color:#fff">
            <button id="et-friend-add" class="btn">Add</button>
          </div>
          <div id="et-friends-status" class="muted" style="margin:2px 0 8px 0"></div>
          <div id="friends-col" class="friends-col"></div>
        </div>
      </section>
    </div>
  </div>

  <!-- Existing project scripts -->
  <script src="source/state/router.js"></script>
  <script src="source/state/session.js"></script>
</body>
</html>
