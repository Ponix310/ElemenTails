<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ElemenTails â€” Main Menu</title>

  <style>
    :root{ --bg:#0b0c10; --panel:#121520; --muted:#9aa4b2; --accent:#20c997; --radius:14px; }
    html,body{height:100%;margin:0;background:var(--bg);color:#e9eef5;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;}
    .wrap{max-width:1180px;margin:32px auto;padding:0 16px;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{margin:0;font-size:28px}
    .auth{display:flex;gap:10px;align-items:center;color:#cbd5e1}
    .pill{background:#0f1220;border:1px solid #2a3147;border-radius:999px;padding:6px 10px;font-size:14px}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;background:#1e2433;color:#fff}
    .btn:hover{filter:brightness(1.08)}
    .btn.primary{background:var(--accent);color:#06241e}
    .card{background:var(--panel);padding:18px;border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.35);}
    .grid{display:grid;gap:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type=text]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3147;background:#0f1320;color:#fff}
    select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3147;background:#0f1320;color:#fff}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.two{grid-template-columns:1fr}}
    .muted{color:#9aa4b2;font-size:12px}
    .columns{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:1100px){ .columns{grid-template-columns:1fr} }

    /* Friends grid tiles */
    .friends-grid{display:grid;grid-template-columns:repeat(2, 1fr);gap:12px}
    @media (min-width:1100px){ .friends-grid{grid-template-columns:repeat(3, 1fr);} }
    .friend-tile{
      position:relative; aspect-ratio:3/2; border-radius:12px; overflow:hidden;
      border:1px solid #2a3147; background:#0f1220; display:flex; align-items:flex-end;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
    }
    .friend-bg{
      position:absolute; inset:0; background-size:cover; background-position:center; opacity:.35;
      filter: saturate(1.1) contrast(1.05);
    }
    .friend-body{position:relative; width:100%; padding:10px; display:flex; align-items:center; justify-content:space-between; backdrop-filter: blur(2px);}
    .friend-name{font-weight:700; text-shadow:0 1px 2px rgba(0,0,0,.6)}
    .friend-cta{display:flex; gap:6px; align-items:center}
    .friend-pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2a3147;background:#0f1220;color:#cbd5e1}
    .friend-btn{padding:8px 10px;border-radius:8px;border:0;background:#1e2433;color:#fff;cursor:pointer}
    .friend-btn.join{background:var(--accent);color:#06241e;font-weight:800}
    .friend-btn:hover{filter:brightness(1.06)}
    .empty-note{padding:8px 0;color:#9aa4b2}
    .avatar-choices{display:grid;grid-template-columns:repeat(6, minmax(68px,1fr));gap:8px}
    .choice{
      aspect-ratio:3/2;border-radius:10px;overflow:hidden;border:2px solid transparent;cursor:pointer;
      background-size:cover;background-position:center
    }
    .choice:hover{filter:brightness(1.08)}
    .choice.active{border-color:var(--accent)}
  </style>

  <!-- Firebase v12 (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, deleteDoc, collection, query, orderBy, onSnapshot, serverTimestamp,
      where, getDocs, addDoc, updateDoc, arrayUnion, limit
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBaIjbM7dVNjKE7CJXPQOievhkiIF17rds",
      authDomain: "elementails.firebaseapp.com",
      projectId: "elementails",
      storageBucket: "elementails.firebasestorage.app",
      messagingSenderId: "497100635124",
      appId: "1:497100635124:web:aeeb25ead96b84751e57a1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Final list of portrait keys based on your screenshot (pngs)
    const PORTRAITS = [
      'archer','assassin','barbarian','bard','battlemage','berserker','cleric',
      'druid','lancer','monk','myrmidon','ninja','paladin','reaper',
      'samurai','summoner','warrior','wizard'
    ];
    // Point at your folder: /images/class-portraits/<key>.png
    const portraitUrl = key => `images/class-portraits/${key}.png`;

    // ---------- Auth UI ----------
    document.addEventListener('DOMContentLoaded', () => {
      const loginBtn = document.getElementById('auth-login');
      const logoutBtn = document.getElementById('auth-logout');
      const namePill = document.getElementById('auth-username');

      loginBtn.addEventListener('click', async () => {
        try { await signInWithPopup(auth, new GoogleAuthProvider()); }
        catch (e) { alert(e.code || 'Login failed'); }
      });
      logoutBtn.addEventListener('click', async () => { try { await signOut(auth); } catch {} });

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          let display = user.displayName || '(user)';
          try {
            const uDoc = await getDoc(doc(db, 'users', user.uid));
            if (uDoc.exists() && uDoc.data().username) display = uDoc.data().username;
          } catch {}
          namePill.textContent = '@' + display;
          namePill.style.display = 'inline-block';
          loginBtn.style.display = 'none';
          logoutBtn.style.display = 'inline-block';
          initMyBanner();
          refreshFriends();
        } else {
          namePill.style.display = 'none';
          loginBtn.style.display = 'inline-block';
          logoutBtn.style.display = 'none';
          document.getElementById('friends-grid').innerHTML = '<div class="empty-note">(sign in to see friends)</div>';
          setStatus('Sign in first.', false);
        }
      });
    });

    // ---------- Session creation ----------
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('create-session-btn').addEventListener('click', onCreateSession);
      document.getElementById('et-friend-add').addEventListener('click', onAdd);
      document.getElementById('et-friend-input').addEventListener('keydown', e => { if(e.key==='Enter') onAdd(); });
    });

    async function onCreateSession(){
      const me = auth.currentUser; if(!me){ alert('Sign in first.'); return; }
      const visibility = document.getElementById('session-visibility').value;
      try {
        const ref = await addDoc(collection(db, 'rooms'), {
          hostUid: me.uid, visibility, status: 'open', mode:'multiplayer',
          partyLocked:false, participantUids:[me.uid], partyUids:[],
          createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        });
        if (window.Session && Session.setRoomCode) Session.setRoomCode(ref.id);
        if (window.Router && Router.to) Router.to('lobby.html?roomId=' + ref.id);
        else location.href = 'lobby.html?roomId=' + ref.id;
      } catch (e) { alert('Could not create session.'); }
    }

    // ---------- Friends add + grid render with banner ---------
    function setStatus(msg, ok=null){
      const el = document.getElementById('et-friends-status');
      el.textContent = msg || '';
      el.className = 'et-friends-status ' + (ok===true ? 'et-ok' : ok===false ? 'et-err' : 'et-muted');
    }

    async function onAdd(){
      const me = auth.currentUser; if(!me){ setStatus('Sign in first.', false); return; }
      const v = (document.getElementById('et-friend-input').value || '').trim();
      if(!v){ setStatus('Type a username.', false); return; }
      const uLower = v.toLowerCase();
      try{
        const claim = await getDoc(doc(db, 'usernames', uLower));
        if(!claim.exists()){ setStatus('User not found.', false); return; }
        const friendUid = claim.data() && claim.data().uid;
        if(!friendUid){ setStatus('User not found.', false); return; }
        if(friendUid === me.uid){ setStatus('Thatâ€™s you ðŸ™‚', false); return; }
        const myRef = doc(db, 'users', me.uid, 'friends', friendUid);
        const exists = await getDoc(myRef);
        if(exists.exists()){ setStatus('Already in your friends.', true); return; }
        await setDoc(myRef, { uid: friendUid, username: v, usernameLower: uLower, addedAt: serverTimestamp() });
        document.getElementById('et-friend-input').value='';
        setStatus('Friend added âœ”', true);
      }catch(e){ setStatus('Could not add friend.', false); }
    }

    function fallbackGradient(uid){
      let h=0; for (let i=0;i<uid.length;i++) h=(h*31+uid.charCodeAt(i))>>>0;
      const a = h%360, b=(h>>8)%360;
      return `linear-gradient(135deg, hsl(${a} 45% 18%), hsl(${b} 45% 22%))`;
    }

    async function fetchPublicPortrait(uid){
      try{
        const p = await getDoc(doc(db,'publicProfiles', uid));
        if (p.exists() && p.data().portrait) return p.data().portrait;
      }catch(e){}
      return null;
    }

    async function renderFriends(items){
      const grid = document.getElementById('friends-grid');
      grid.innerHTML = '';
      if(!items || !items.length){ grid.innerHTML = '<div class="empty-note">(none yet)</div>'; return; }
      const me = auth.currentUser;
      for (const it of items){
        const tile = document.createElement('div'); tile.className='friend-tile';
        const bg = document.createElement('div'); bg.className='friend-bg';
        const portraitKey = await fetchPublicPortrait(it.id);
        if (portraitKey) bg.style.backgroundImage = `url('${portraitUrl(portraitKey)}')`;
        else bg.style.background = fallbackGradient(it.id);
        tile.appendChild(bg);

        const body = document.createElement('div'); body.className='friend-body';
        const name = document.createElement('div'); name.className='friend-name'; name.textContent = it.username || it.usernameLower || it.id;
        const right = document.createElement('div'); right.className='friend-cta';

        const pill = document.createElement('span'); pill.className='friend-pill'; pill.textContent='Checkingâ€¦';
        const join = document.createElement('button'); join.className='friend-btn join'; join.textContent='Join'; join.style.display='none';
        const rm   = document.createElement('button'); rm.className='friend-btn'; rm.textContent='Remove';

        rm.onclick = async () => {
          try{ await deleteDoc(doc(db, 'users', me.uid, 'friends', it.id)); setStatus('Removed.', true); }
          catch{ setStatus('Could not remove.', false); }
        };

        try{
          const q1 = query(collection(db,'rooms'), where('participantUids','array-contains', it.id), orderBy('createdAt','desc'), limit(5));
          const ss = await getDocs(q1);
          let joinable=null;
          ss.forEach(d=>{
            const r = d.data(); r.id=d.id;
            if (r.visibility==='private') return;
            if (r.partyLocked){
              const party = Array.isArray(r.partyUids)?r.partyUids:[];
              if (!me || !party.includes(me.uid)) return;
            }
            if (!joinable) joinable=r;
          });
          if (joinable){
            pill.textContent = (joinable.status||'open') + ' â€¢ ' + (joinable.visibility||'friends');
            join.style.display='inline-block';
            join.onclick = () => {
              if (window.Session && Session.setRoomCode) Session.setRoomCode(joinable.id);
              if (window.Router && Router.to) Router.to('lobby.html?roomId='+joinable.id);
              else location.href = 'lobby.html?roomId='+joinable.id;
            };
          } else { pill.textContent='No session'; }
        }catch{ pill.textContent='No session'; }

        right.appendChild(pill); right.appendChild(join); right.appendChild(rm);
        body.appendChild(name); body.appendChild(right);
        tile.appendChild(body);
        grid.appendChild(tile);
      }
    }

    let unsub=null;
    function refreshFriends(){
      if (unsub) try{unsub();}catch{}
      const me = auth.currentUser; if(!me) return;
      const q = query(collection(db,'users', me.uid, 'friends'), orderBy('usernameLower'));
      unsub = onSnapshot(q, (snap)=>{
        const items = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderFriends(items); setStatus('Ready.', true);
      }, ()=> setStatus('Could not load friends.', false));
    }

    // ---------- My banner chooser (writes to publicProfiles/<uid>) ----------
    async function initMyBanner(){
      const me = auth.currentUser; if (!me) return;
      const grid = document.getElementById('avatar-choices');
      grid.innerHTML = '';
      let current = null;
      try{
        const p = await getDoc(doc(db,'publicProfiles', me.uid));
        if (p.exists()) current = p.data().portrait || null;
      }catch{}

      PORTRAITS.forEach(key => {
        const c = document.createElement('div'); c.className='choice';
        c.style.backgroundImage = `url('${portraitUrl(key)}')`;
        if (current===key) c.classList.add('active');
        c.title = key;
        c.onclick = async () => {
          try{
            await setDoc(doc(db,'publicProfiles', me.uid), { uid: me.uid, portrait: key, updatedAt: serverTimestamp() }, { merge:true });
            [...grid.children].forEach(el=>el.classList.remove('active'));
            c.classList.add('active');
          }catch(e){
            alert('Could not save banner (check rules for /publicProfiles).');
          }
        };
        grid.appendChild(c);
      });
    }
  </script>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Elemen Tails</h1>
        <div class="muted">Create a session and invite friends. Customize your banner.</div>
      </div>
      <div class="auth">
        <span id="auth-username" class="pill" style="display:none;"></span>
        <button id="auth-login" class="btn">Login with Google</button>
        <button id="auth-logout" class="btn" style="display:none;">Logout</button>
      </div>
    </header>

    <div class="columns">
      <!-- LEFT: Create Session & My Banner -->
      <section class="card grid">
        <div class="two">
          <div>
            <label for="session-visibility">Session visibility</label>
            <select id="session-visibility">
              <option value="private">Private</option>
              <option value="friends" selected>Friends only</option>
              <option value="public">Public</option>
            </select>
          </div>
          <div style="display:flex;align-items:flex-end;">
            <button id="create-session-btn" class="btn primary">Create Session</button>
          </div>
        </div>
        <div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="muted">My Banner (Class Portrait)</div>
          </div>
          <div id="avatar-choices" class="avatar-choices"></div>
          <div class="muted">Looks for files at <code>images/class-portraits/&lt;key&gt;.png</code>. Missing images fall back to a gradient.</div>
        </div>
      </section>

      <!-- RIGHT: Friends grid -->
      <section class="card">
        <h2 style="margin:0 0 10px 0;font-size:18px">Friends</h2>
        <div class="row" style="gap:8px;align-items:center">
          <input id="et-friend-input" type="text" placeholder="Enter username" style="flex:1;padding:10px 12px;border-radius:10px;border:1px solid #2a3147;background:#0f1320;color:#fff">
          <button id="et-friend-add" class="btn">Add</button>
        </div>
        <div id="et-friends-status" class="muted" style="margin:6px 0 10px 0"></div>
        <div id="friends-grid" class="friends-grid"></div>
        <div class="muted" style="margin-top:8px">Add friends by <strong>username</strong>. See if they have a joinable session.</div>
      </section>
    </div>
  </div>

  <!-- Existing project scripts -->
  <script src="source/state/router.js"></script>
  <script src="source/state/session.js"></script>
</body>
</html>
