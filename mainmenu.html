<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ElemenTails â€” Main Menu</title>

  <style>
    :root{ --bg:#0b0c10; --panel:#121520; --muted:#9aa4b2; --accent:#20c997; --radius:14px; }
    html,body{height:100%;margin:0;background:var(--bg);color:#e9eef5;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{margin:0;font-size:28px}
    .auth{display:flex;gap:10px;align-items:center;color:#cbd5e1}
    .pill{background:#0f1220;border:1px solid #2a3147;border-radius:999px;padding:6px 10px;font-size:14px}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;background:#1e2433;color:#fff}
    .btn:hover{filter:brightness(1.08)}
    .btn.primary{background:var(--accent);color:#06241e}
    .card{background:var(--panel);padding:18px;border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.35);}
    .grid{display:grid;gap:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type=text]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3147;background:#0f1320;color:#fff}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.two{grid-template-columns:1fr}}
    .muted{color:var(--muted);font-size:12px}
    .columns{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:1100px){ .columns{grid-template-columns:1fr} }
    .note{font-size:12px;color:#9aa4b2;margin-left:8px}

    /* Friends UI */
    .et-friends { display:grid; gap:10px; }
    .et-friends-row { display:flex; gap:8px; align-items:center; }
    .et-friends-input { flex:1; padding:10px; border-radius:10px; border:1px solid #2a3147; background:#0f1320; color:#fff }
    .et-friends-btn { padding:10px 14px; border-radius:10px; border:0; background:#20c997; color:#06241e; font-weight:700; cursor:pointer }
    .et-friends-btn.secondary { background:#1e2433; color:#fff }
    .et-friends-status { min-height:18px; font-size:12px }
    .et-ok { color:#63e6be } .et-err { color:#ff6b6b } .et-muted { color:#9aa4b2 }
    .et-friends-list { display:grid; gap:6px }
    .et-friends-item { display:flex; align-items:center; justify-content:space-between; background:#0f1220; border:1px solid #2a3147; border-radius:10px; padding:8px 10px }
  </style>

  <!-- Firebase Web v12 (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // IMPORTANT: exact config known-good
    const firebaseConfig = {
      apiKey: "AIzaSyBaIjbm7dVNjKE7CJXPQiOevhiK1FI77ds",
      authDomain: "elementails.firebaseapp.com",
      projectId: "elementails",
      storageBucket: "elementails.firebasestorage.app",
      messagingSenderId: "497100635124",
      appId: "1:497100635124:web:aeeb25ead96b84751e57a1",
      measurementId: "G-H7ZXWH59GS"
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function setAuthStatus(tone, msg){
      const s = document.getElementById('auth-status');
      s.textContent = msg || '';
      s.style.color = tone === 'ok' ? '#63e6be' : tone === 'warn' ? '#ffd43b' : '#ff6b6b';
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const loginBtn = document.getElementById('auth-login');
      const logoutBtn = document.getElementById('auth-logout');
      const namePill = document.getElementById('auth-username');

      // After redirect fallback, surface any error
      try {
        const rr = await getRedirectResult(auth);
        if (rr && rr.user) setAuthStatus('ok', 'Signed in via redirect.');
      } catch (e) {
        setAuthStatus('err', (e.code||'login-failed') + ' â€” ' + (e.message||''));
      }

      loginBtn.addEventListener('click', async () => {
        try {
          const provider = new GoogleAuthProvider();
          await signInWithPopup(auth, provider);
        } catch (e) {
          // Fallback to redirect for popup issues; show clear error otherwise
          if (e.code === 'auth/popup-blocked' || e.code === 'auth/popup-closed-by-user') {
            setAuthStatus('warn', 'Popup blockedâ€”using redirectâ€¦');
            try { await signInWithRedirect(auth, new GoogleAuthProvider()); }
            catch (er) { setAuthStatus('err', (er.code||'redirect-failed') + ' â€” ' + (er.message||'')); }
          } else {
            setAuthStatus('err', (e.code||'login-failed') + ' â€” ' + (e.message||''));
          }
        }
      });

      logoutBtn.addEventListener('click', async () => {
        try { await signOut(auth); setAuthStatus('ok', 'Signed out.'); }
        catch (e) { setAuthStatus('err', (e.code||'logout-failed') + ' â€” ' + (e.message||'')); }
      });

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          let display = user.displayName || '(user)';
          try {
            const uDoc = await getDoc(doc(db, 'users', user.uid));
            if (uDoc.exists() && uDoc.data().username) display = uDoc.data().username;
          } catch {}
          namePill.textContent = '@' + display;
          namePill.style.display = 'inline-block';
          loginBtn.style.display = 'none';
          logoutBtn.style.display = 'inline-block';
          setAuthStatus('ok', 'Signed in.');
          refreshFriends();
        } else {
          namePill.style.display = 'none';
          loginBtn.style.display = 'inline-block';
          logoutBtn.style.display = 'none';
          setAuthStatus('warn', 'Not signed in.');
          document.getElementById('et-friends-list').innerHTML = '<div class="et-muted">(none yet)</div>';
          setStatus('Sign in first.', false);
          stopFriendsWatch();
        }
      });

      // ---- Friends logic ----
      const statusEl = document.getElementById('et-friends-status');
      const listEl = document.getElementById('et-friends-list');
      const inputEl = document.getElementById('et-friend-input');
      const addBtn  = document.getElementById('et-friend-add');
      let unsubFriends = null;

      function setStatus(msg, ok=null){
        statusEl.textContent = msg || '';
        statusEl.className = 'et-friends-status ' + (ok===true ? 'et-ok' : ok===false ? 'et-err' : 'et-muted');
      }
      function needAuth(){
        const u = auth.currentUser;
        if(!u){ setStatus('Sign in first.', false); return null; }
        return u;
      }
      function stopFriendsWatch(){ if (typeof unsubFriends === 'function') { try { unsubFriends(); } catch {} } unsubFriends = null; }

      addBtn.addEventListener('click', onAdd);
      inputEl.addEventListener('keydown', e => { if(e.key==='Enter') onAdd(); });

      async function onAdd(){
        const me = needAuth(); if(!me) return;
        const v = (inputEl.value || '').trim();
        if(!v){ setStatus('Type a username.', false); return; }
        addBtn.disabled = true; setStatus('Searchingâ€¦');
        try{
          const uLower = v.toLowerCase();
          const claim = await getDoc(doc(db, 'usernames', uLower));
          if(!claim.exists()){ setStatus('User not found.', false); addBtn.disabled=false; return; }
          const friendUid = claim.data() && claim.data().uid;
          if(!friendUid){ setStatus('User not found.', false); addBtn.disabled=false; return; }
          if(friendUid === me.uid){ setStatus('Thatâ€™s you ðŸ™‚', false); addBtn.disabled=false; return; }
          const myFriendRef = doc(db, 'users', me.uid, 'friends', friendUid);
          const existing = await getDoc(myFriendRef);
          if(existing.exists()){ setStatus('Already in your friends.', true); addBtn.disabled=false; return; }
          await setDoc(myFriendRef, { uid: friendUid, username: v, usernameLower: uLower, addedAt: serverTimestamp() });
          inputEl.value=''; setStatus('Friend added âœ”', true);
        }catch(e){ setStatus((e.code||'could-not-add')+' â€” '+(e.message||''), false); }
        finally{ addBtn.disabled=false; }
      }

      function renderFriends(items){
        listEl.innerHTML = '';
        if(!items || !items.length){ listEl.innerHTML = '<div class="et-muted">(none yet)</div>'; return; }
        for(const it of items){
          const row = document.createElement('div'); row.className='et-friends-item';
          const name = document.createElement('span'); name.textContent = it.username || it.usernameLower || it.id;
          const rm = document.createElement('button'); rm.className='et-friends-btn secondary'; rm.textContent='Remove';
          rm.onclick = async () => {
            const me = needAuth(); if(!me) return;
            try{ await deleteDoc(doc(db, 'users', me.uid, 'friends', it.id)); setStatus('Removed.', true); }
            catch(err){ setStatus((err.code||'could-not-remove')+' â€” '+(err.message||''), false); }
          };
          const right = document.createElement('div'); right.appendChild(rm);
          row.append(name, right); listEl.appendChild(row);
        }
      }

      function refreshFriends(){
        stopFriendsWatch();
        const me = auth.currentUser; if(!me) return;
        const q = query(collection(db, 'users', me.uid, 'friends'), orderBy('usernameLower'));
        unsubFriends = onSnapshot(q, (snap) => {
          const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          renderFriends(items); setStatus('Ready.', true);
        }, (err) => { setStatus((err.code||'could-not-load')+' â€” '+(err.message||''), false); });
      }

      // Seed SP/MP fields from saved session
      document.getElementById('playerName').value = (window.Session && Session.getName && Session.getName()) || '';
      document.getElementById('lastRoom').value  = (window.Session && Session.getRoomCode && Session.getRoomCode()) || '';
    });
  </script>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Elemen Tails</h1>
        <div class="muted">Prototype menu â€¢ Singleplayer & Multiplayer lobby</div>
      </div>
      <div class="auth">
        <span id="auth-username" class="pill" style="display:none;"></span>
        <button id="auth-login" class="btn">Login with Google</button>
        <button id="auth-logout" class="btn" style="display:none;">Logout</button>
        <span id="auth-status" class="note"></span>
      </div>
    </header>

    <div class="columns">
      <!-- LEFT: SP/MP -->
      <section class="card grid">
        <div class="row">
          <button class="btn primary" onclick="Router.to('partyselect.html')">Singleplayer: New Run</button>
          <button class="btn" onclick="Router.to('lobby.html')">Multiplayer</button>
        </div>
        <div class="two">
          <div>
            <label for="playerName">Player name</label>
            <input id="playerName" type="text" placeholder="Ponix" oninput="Session.setName(this.value)">
          </div>
          <div>
            <label for="lastRoom">Last room</label>
            <input id="lastRoom" type="text" placeholder="Auto-savedâ€¦" oninput="Session.setRoomCode(this.value)">
          </div>
        </div>
        <div class="row">
          <button class="btn" onclick="Session.mockFill()">Quick-fill demo</button>
          <button class="btn" onclick="localStorage.clear();alert('Cleared localStorage for ElemenTails');">Clear saved</button>
        </div>
      </section>

      <!-- RIGHT: Friends -->
      <section class="card">
        <h2 style="margin:0 0 10px 0;font-size:18px">Friends</h2>
        <div class="et-friends">
          <div class="et-friends-row">
            <input id="et-friend-input" class="et-friends-input" type="text" placeholder="Enter username">
            <button id="et-friend-add" class="et-friends-btn">Add</button>
          </div>
          <div id="et-friends-status" class="et-friends-status et-muted"></div>
          <div id="et-friends-list" class="et-friends-list"></div>
        </div>
        <div class="muted" style="margin-top:8px">Add friends by <strong>username</strong>. No friend codes.</div>
      </section>
    </div>
  </div>

  <!-- Existing project scripts (router/session) -->
  <script src="source/state/router.js"></script>
  <script src="source/state/session.js"></script>
</body>
</html>
