<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ElemenTails — Main Menu</title>
  <style>
    :root{ --bg:#0b0c10; --panel:#121520; --muted:#9aa4b2; --accent:#20c997; --radius:14px; }
    html,body{height:100%;margin:0;background:var(--bg);color:#e9eef5;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px;display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media (max-width:1100px){ .wrap{grid-template-columns:1fr;} .right{order:-1} }
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;grid-column:1/-1}
    h1{margin:0;font-size:28px}
    .auth{display:flex;gap:10px;align-items:center;color:#cbd5e1}
    .pill{background:#0f1220;border:1px solid #2a3147;border-radius:999px;padding:6px 10px;font-size:14px}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer;background:#1e2433;color:#fff;box-shadow:0 2px 0 rgba(0,0,0,.25) inset}
    .btn:hover{filter:brightness(1.06)}
    .btn.primary{background:var(--accent);color:#06241e}
    .btn.success{background:#1db954;color:#06241e}
    .btn.ghost{background:#1e2433;color:#cbd5e1}
    .btn.small{padding:8px 10px;border-radius:10px;font-weight:700}
    .btn[disabled]{opacity:.55;cursor:not-allowed;filter:none}
    .card{background:var(--panel);padding:18px;border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.35);}
    .grid{display:grid;gap:12px}
    .muted{color:#9aa4b2;font-size:12px}
    .slots{display:grid;grid-template-columns:1fr;gap:10px}
    .slot{display:flex;align-items:center;justify-content:space-between;border:1px solid #2a3147;background:#0f1220;border-radius:10px;padding:12px}
    .slot .left{display:flex;flex-direction:column}
    .slot .title{font-weight:800}
    .friend{display:flex;align-items:center;justify-content:space-between;border:1px solid #2a3147;background:#0f1220;border-radius:10px;padding:10px}
    .status{display:inline-flex;align-items:center;gap:6px}
    .dot{width:8px;height:8px;border-radius:999px;background:#64748b}
    .dot.online{background:#22c55e}
  </style>
</head>
<body>
  <header class="wrap">
    <div>
      <h1>ElemenTails</h1>
      <div class="muted">Create a session and invite friends.</div>
    </div>
    <div class="auth">
      <span id="auth-username" class="pill" style="display:none;"></span>
      <button id="auth-login" class="btn">Login with Google</button>
      <button id="auth-logout" class="btn" style="display:none;">Logout</button>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h3 style="margin:0 0 8px;font-size:16px;color:#e2e8f0">Your Save Slots</h3>
      <div id="slots-header" class="muted" style="margin-bottom:10px;">Save Slots — 0/5 used</div>
      <div id="slots-wrap" class="slots"></div>
    </section>

    <aside class="right">
      <section class="card">
        <h3 style="margin:0 0 8px;font-size:16px;color:#e2e8f0">Friends</h3>
        <div id="friends-list" class="grid"></div>
      </section>
    </aside>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, serverTimestamp,
      writeBatch, getDocs, query, where, onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBaIjbM7dVNjKE7CJXPQOievhkiIF17rds",
      authDomain: "elementails.firebaseapp.com",
      projectId: "elementails",
      storageBucket: "elementails.firebasestorage.app",
      messagingSenderId: "497100635124",
      appId: "1:497100635124:web:aeeb25ead96b84751e57a1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const SLOT_IDS = ["slot1","slot2","slot3","slot4","slot5"];

    // ---------- Helpers ----------
    function slotRef(uid, slotId){ return doc(db, `users/${uid}/slots/${slotId}`); }
    function routeToPartySelect(roomId, mode){
      try {
        const norm = (mode === 'friends' || mode === 'public' || mode === 'multiplayer' || mode === 'multi') ? 'multi' : 'single';
        localStorage.setItem('ET_mode', norm);
      } catch {}
      window.location.href = `partyselect.html?roomId=${encodeURIComponent(roomId)}`;
    }
    function clearLocalForRoom(roomId){
      try{
        for (const v of ['v2','v3','v4']){
          localStorage.removeItem(`ET_ps_${v}:${roomId}`);
        }
      }catch{}
    }

    // ---------- Auth UI ----------
    document.addEventListener('DOMContentLoaded', () => {
      const loginBtn = document.getElementById('auth-login');
      const logoutBtn = document.getElementById('auth-logout');
      const namePill = document.getElementById('auth-username');

      loginBtn.addEventListener('click', async () => {
        try { await signInWithPopup(auth, new GoogleAuthProvider()); }
        catch (e) { alert(e.code || 'Login failed'); }
      });
      logoutBtn.addEventListener('click', async () => { try { await signOut(auth); } catch {} });

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          let display = user.displayName || '(user)';
          try {
            const uDoc = await getDoc(doc(db, 'users', user.uid));
            if (uDoc.exists() && uDoc.data().username) display = uDoc.data().username;
          } catch {}
          namePill.textContent = '@' + display;
          namePill.style.display = 'inline-block';
          loginBtn.style.display = 'none';
          logoutBtn.style.display = 'inline-block';
          refreshSlots();
          refreshFriends();
        } else {
          namePill.style.display = 'none';
          loginBtn.style.display = 'inline-block';
          logoutBtn.style.display = 'none';
          document.getElementById('slots-wrap').innerHTML = '<div class="muted">Sign in to see your save slots.</div>';
          document.getElementById('friends-list').innerHTML = '<div class="muted">Sign in to see friends.</div>';
        }
      });
    });

    // ---------- Slots ----------
    async function refreshSlots(){
      const me = auth.currentUser; if(!me) return;
      const wrap = document.getElementById('slots-wrap'); wrap.innerHTML='';

      const entries = [];
      for (const id of SLOT_IDS){
        const sSnap = await getDoc(slotRef(me.uid, id));
        const s = sSnap.exists() ? sSnap.data() : {};
        let room = null;
        if (s?.roomId){
          const rSnap = await getDoc(doc(db, 'rooms', s.roomId));
          if (rSnap.exists()) room = { id: rSnap.id, ...rSnap.data() };
          else room = { id: s.roomId, missing: true };
        }
        entries.push({ id, slot: s, room });
      }

      const used = entries.filter(e => e.slot?.roomId).length;
      document.getElementById('slots-header').textContent = `Save Slots — ${used}/5 used`;

      entries.forEach(e => renderSlotRow(wrap, e));
    }

    function renderSlotRow(wrap, e){
      const row = document.createElement('div');
      row.className = 'slot';
      const left = document.createElement('div'); left.className='left';
      const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px';

      if (e.room){
        left.innerHTML = `<div class="title">Slot ${e.id.slice(4)} — Room ${e.room.id.slice(0,6)}…</div>
                          <div class="muted">${e.room.missing ? '(Missing room doc)' : `Status: ${e.room.status || 'open'} · Visibility: ${e.room.visibility || 'friends'}`}</div>`;
        const loadBtn = document.createElement('button'); loadBtn.className='btn small'; loadBtn.textContent='Load';
        loadBtn.onclick = ()=> routeToPartySelect(e.room.id, e.room.visibility || 'friends');

        const delBtn = document.createElement('button'); delBtn.className='btn ghost small'; delBtn.textContent='Delete';
        delBtn.onclick = ()=> deleteSlotRoom(e.id, e.room.id);

        right.appendChild(loadBtn); right.appendChild(delBtn);
      } else {
        left.innerHTML = `<div class="title">Slot ${e.id.slice(4)} — Empty</div>
                          <div class="muted">Create a new run here.</div>`;
        const mkSolo = document.createElement('button'); mkSolo.className='btn small primary'; mkSolo.textContent='Create Singleplayer';
        mkSolo.onclick = ()=> createInSlot(e.id, 'private');
        const mkMulti = document.createElement('button'); mkMulti.className='btn small success'; mkMulti.textContent='Create Multiplayer';
        mkMulti.onclick = ()=> createInSlot(e.id, 'friends');
        right.appendChild(mkSolo); right.appendChild(mkMulti);
      }
      row.appendChild(left); row.appendChild(right);
      wrap.appendChild(row);
    }

    async function createInSlot(slotId, visibility){
      const me = auth.currentUser; if(!me){ alert('Sign in first.'); return; }
      const sSnap = await getDoc(slotRef(me.uid, slotId));
      if (sSnap.exists() && sSnap.data()?.roomId){
        alert('That slot is no longer empty. Choose another or delete first.'); return;
      }
      const batch = writeBatch(db);
      const roomRef = doc(collection(db,'rooms'));
      batch.set(roomRef, {
        hostUid: me.uid,
        slotId,
        visibility,
        status: 'open',
        mode: visibility === 'private' ? 'solo' : 'multiplayer',
        partyLocked:false,
        maxParty:4,
        participantUids:[me.uid],
        partyUids:[me.uid],
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      });
      batch.set(slotRef(me.uid, slotId), {
        roomId: roomRef.id,
        visibility,
        createdAt: serverTimestamp(),
      }, { merge: true });
      try{
        await batch.commit();
        routeToPartySelect(roomRef.id, visibility);
      }catch(e){
        alert(e.message || e.code || 'Could not create session.'); await refreshSlots();
      }
    }

    async function deleteSlotRoom(slotId, roomId){
      const me = auth.currentUser; if(!me){ alert('Sign in first.'); return; }
      if (!confirm('Delete this save? This cannot be undone.')) return;
      const batch = writeBatch(db);
      batch.delete(doc(db, 'rooms', roomId));
      batch.set(slotRef(me.uid, slotId), { roomId: null, deletedAt: serverTimestamp() }, { merge: true });
      try{
        await batch.commit();
        clearLocalForRoom(roomId); await refreshSlots();
      }catch(e){
        alert(e.message || e.code || 'Failed to delete save.');
      }
    }

    // ---------- Friends panel (publicProfiles + usernames) ----------
    async function refreshFriends(){
      const me = auth.currentUser; if(!me) return;
      const list = document.getElementById('friends-list');
      list.innerHTML = '';
      try{
        const ss = await getDocs(query(collection(db, `users/${me.uid}/friends`)));
        if (ss.empty){ list.innerHTML = '<div class="muted">(No friends yet)</div>'; return; }

        async function resolveHandle(friendUid){
          try{
            const pSnap = await getDoc(doc(db,'publicProfiles', friendUid));
            if (pSnap.exists()){
              const pd = pSnap.data();
              if (pd.username && String(pd.username).length) return pd.username;
              if (pd.displayName && String(pd.displayName).length) return pd.displayName;
            }
          }catch{}
        try{
            const res = await getDocs(query(collection(db,'usernames'), where('uid','==', friendUid)));
            if (!res.empty){ return res.docs[0].id; }
          }catch{}
          return friendUid.slice(0,6);
        }

        for (const ds of ss.docs){
          const fuid = ds.id;
          const handle = await resolveHandle(fuid);
          const row = document.createElement('div'); row.className='friend';
          const left = document.createElement('div'); left.textContent = '@'+handle;
          const right = document.createElement('div'); right.className='status'; right.innerHTML = '<span class="dot"></span><span class="muted">offline</span>';
          const dot = right.querySelector('.dot'); const txt = right.querySelector('span + span');
          onSnapshot(doc(db,'presence', fuid), (snap)=>{
            const online = snap.exists() && snap.data().online;
            dot.className = online ? 'dot online' : 'dot';
            txt.textContent = online ? 'online' : 'offline';
          });
          row.appendChild(left); row.appendChild(right);
          list.appendChild(row);
        }
      }catch(e){
        list.innerHTML = `<div class="muted">Could not load friends: ${e.message||e.code}</div>`;
      }
    }
  </script>
</body>
</html>
