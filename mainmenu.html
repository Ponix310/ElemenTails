<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ElemenTails — Main Menu</title>
  <meta name="screen" content="Main Menu">

  <style>
    :root{ --bg:#0b0c10; --panel:#121520; --muted:#9aa4b2; --accent:#20c997; --radius:14px; }
    html,body{height:100%;margin:0;background:var(--bg);color:#e9eef5;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;}
    .wrap{max-width:1180px;margin:32px auto;padding:0 16px;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{margin:0;font-size:28px}
    .auth{display:flex;gap:10px;align-items:center;color:#cbd5e1}
    .pill{background:#0f1220;border:1px solid #2a3147;border-radius:999px;padding:6px 10px;font-size:14px}
    .btn{appearance:none;border:0;border-radius:12px;padding:14px 16px;font-weight:700;cursor:pointer;background:#1e2433;color:#fff;box-shadow:0 2px 0 rgba(0,0,0,.25) inset}
    .btn:hover{filter:brightness(1.06)}
    .btn.primary{background:var(--accent);color:#06241e}
    .btn.success{background:#1db954;color:#06241e}
    .btn.ghost{background:#1e2433;color:#cbd5e1}
    .btn.small{padding:8px 10px;border-radius:10px;font-weight:700}
    .btn[disabled]{opacity:.55;cursor:not-allowed;filter:none}
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:10px;padding:0}
    .card{background:var(--panel);padding:18px;border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.35);}
    .grid{display:grid;gap:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .muted{color:#9aa4b2;font-size:12px}
    .columns{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:1100px){ .columns{grid-template-columns:1fr} }

    .tile-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .action-tile{display:flex;align-items:center;justify-content:center;height:180px;border-radius:14px;border:1px solid #2a3147;background:#122033;cursor:pointer;font-weight:800}
    .action-tile.primary{background:#20c997}
    .action-tile.success{background:#1db954}
    .action-tile .label{pointer-events:none}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, deleteDoc, collection, query, orderBy, serverTimestamp,
      where, getDocs, addDoc, limit, getCountFromServer
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBaIjbM7dVNjKE7CJXPQOievhkiIF17rds",
      authDomain: "elementails.firebaseapp.com",
      projectId: "elementails",
      storageBucket: "elementails.firebasestorage.app",
      messagingSenderId: "497100635124",
      appId: "1:497100635124:web:aeeb25ead96b84751e57a1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const SAVE_LIMIT = 5;

    // ---------- Navigation ----------
    function routeToPartySelect(roomId, mode){
      try {
        if (mode !== undefined && mode !== null) {
          const m = String(mode).toLowerCase();
          const norm = (m === 'multiplayer' || m === 'multi' || m === 'friends' || m === 'public') ? 'multi' : 'single';
          localStorage.setItem('ET_mode', norm);
        }
      } catch (e) {}
      const url = `partyselect.html?roomId=${encodeURIComponent(roomId)}`;
      if (window.Router && typeof Router.to === 'function') { Router.to(url); return; }
      window.location.href = url;
    }

    // ---------- Auth UI ----------
    document.addEventListener('DOMContentLoaded', () => {
      const loginBtn = document.getElementById('auth-login');
      const logoutBtn = document.getElementById('auth-logout');
      const namePill = document.getElementById('auth-username');

      loginBtn.addEventListener('click', async () => {
        try { await signInWithPopup(auth, new GoogleAuthProvider()); }
        catch (e) { alert(e.code || 'Login failed'); }
      });
      logoutBtn.addEventListener('click', async () => { try { await signOut(auth); } catch {} });

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          let display = user.displayName || '(user)';
          try {
            const uDoc = await getDoc(doc(db, 'users', user.uid));
            if (uDoc.exists() && uDoc.data().username) display = uDoc.data().username;
          } catch {}
          namePill.textContent = '@' + display;
          namePill.style.display = 'inline-block';
          loginBtn.style.display = 'none';
          logoutBtn.style.display = 'inline-block';
        } else {
          namePill.style.display = 'none';
          loginBtn.style.display = 'inline-block';
          logoutBtn.style.display = 'none';
        }
      });
    });

    // ---------- Create / Load ----------
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('tile-single')?.addEventListener('click', ()=> createSession('private'));
      document.getElementById('tile-multi')?.addEventListener('click', ()=> createSession('friends'));
      document.getElementById('btn-load')?.addEventListener('click', toggleLoadList);
      document.getElementById('btn-delete-all')?.addEventListener('click', deleteAllMyRooms);
    });

    async function currentSavesCount(uid){
      const qy = query(collection(db,'rooms'), where('hostUid','==', uid));
      const snap = await getCountFromServer(qy);
      return snap.data().count || 0;
    }

    async function createSession(visibility){
      const me = auth.currentUser; if(!me){ alert('Sign in first.'); return; }
      try {
        const count = await currentSavesCount(me.uid);
        if (count >= SAVE_LIMIT){
          alert(`You have ${count}/${SAVE_LIMIT} saves. Please delete a save slot first.`);
          return;
        }
        const ref = await addDoc(collection(db, 'rooms'), {
          hostUid: me.uid, visibility, status: 'open', mode: (visibility==='private' ? 'solo' : 'multiplayer'),
          partyLocked:false, maxParty:4, participantUids:[me.uid], partyUids:[me.uid],
          createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        });
        routeToPartySelect(ref.id, visibility);
      } catch (e) { alert(e.message || 'Could not create session.'); }
    }

    function toggleLoadList(){
      const panel = document.getElementById('load-list');
      if (!panel) return;
      const showing = panel.style.display !== 'none';
      panel.style.display = showing ? 'none' : 'block';
      if (!showing) loadHostedSessions();
    }

    function roomKeyVariants(roomId){
      return [
        `ET_ps_v2:${roomId}`,
        `ET_ps_v3:${roomId}`,
        `ET_ps_v4:${roomId}`,
        `ET_ps_v2:standalone`,
        `ET_ps_v3:standalone`,
        `ET_ps_v4:standalone`,
      ];
    }
    function clearLocalForRoom(roomId){
      try{ roomKeyVariants(roomId).forEach(k => localStorage.removeItem(k)); }catch{}
    }

    async function loadHostedSessions(){
      const me = auth.currentUser; if(!me){ return; }
      const wrap = document.getElementById('load-items'); if(!wrap) return;
      const header = document.getElementById('load-header');
      wrap.innerHTML = '';
      try {
        const qy = query(collection(db,'rooms'), where('hostUid','==', me.uid), orderBy('createdAt','desc'), limit(SAVE_LIMIT));
        const ss = await getDocs(qy);
        const used = ss.size;
        header.textContent = `Your previously hosted sessions — ${used}/${SAVE_LIMIT} slots used:`;
        if (ss.empty){
          wrap.innerHTML = '<div class="muted">(No saves found)</div>';
          return;
        }
        ss.forEach(docSnap => appendRoomRow(wrap, { id: docSnap.id, ...docSnap.data() }));
      } catch (e) {
        wrap.innerHTML = `<div class="muted">Could not load your saves. ${e.message||e.code||''}</div>`;
      }
    }

    function appendRoomRow(wrap, r){
      const row = document.createElement('div');
      row.style.cssText = 'display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px solid #2a3147;background:#0f1220;border-radius:10px;padding:10px';
      const left = document.createElement('div');
      const when = r.createdAt?.toDate ? r.createdAt.toDate().toLocaleString() : '[unknown time]';
      left.innerHTML = `<div style="font-weight:700">Room ${r.id.slice(0,6)}…</div>
                        <div class="muted">Status: ${r.status||'open'} · Visibility: ${r.visibility||'friends'} · ${when}</div>`;
      const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px';

      const loadBtn = document.createElement('button'); loadBtn.className='btn small'; loadBtn.textContent='Load';
      loadBtn.onclick = () => routeToPartySelect(r.id);

      const delBtn = document.createElement('button'); delBtn.className='btn ghost icon-btn'; delBtn.title='Delete save';
      delBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        <line x1="10" y1="11" x2="10" y2="17"></line>
        <line x1="14" y1="11" x2="14" y2="17"></line>
      </svg>`;
      delBtn.onclick = async () => {
        if (!confirm('Delete this save? This cannot be undone.')) return;
        try{
          await deleteDoc(doc(db,'rooms', r.id));
          clearLocalForRoom(r.id);
          row.remove();
          // refresh header count
          loadHostedSessions();
        }catch(e){
          alert(`Failed to delete save.\n${e.message||e.code||e}`);
        }
      };

      right.appendChild(loadBtn);
      right.appendChild(delBtn);
      row.appendChild(left);
      row.appendChild(right);
      wrap.appendChild(row);
    }

    async function deleteAllMyRooms(){
      const me = auth.currentUser; if(!me){ alert('Sign in first.'); return; }
      if (!confirm('Delete ALL saves shown (up to 5 most recent)?')) return;
      try {
        const qy = query(collection(db,'rooms'), where('hostUid','==', me.uid), orderBy('createdAt','desc'), limit(SAVE_LIMIT));
        const ss = await getDocs(qy);
        const ids = ss.docs.map(d=>d.id);
        await Promise.all(ids.map(id => deleteDoc(doc(db,'rooms', id)).catch(e => e)));
        ids.forEach(id => clearLocalForRoom(id));
        await loadHostedSessions();
        alert('Deleted available saves. If any reappear, your Firestore rules may be preventing deletes.');
      } catch (e) {
        alert(`Bulk delete failed.\n${e.message||e.code||e}`);
      }
    }
  </script>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ElemenTails</h1>
        <div class="muted">Create a session and invite friends.</div>
      </div>
      <div class="auth">
        <span id="auth-username" class="pill" style="display:none;"></span>
        <button id="auth-login" class="btn">Login with Google</button>
        <button id="auth-logout" class="btn" style="display:none;">Logout</button>
      </div>
    </header>

    <div class="columns">
      <!-- LEFT: Action tiles + Load list -->
      <section class="card grid">
        <div class="tile-grid">
          <div id="tile-single" class="action-tile primary"><span class="label">Create Singleplayer Game</span></div>
          <div id="tile-multi" class="action-tile success"><span class="label">Create Multiplayer Game</span></div>
        </div>
        <div class="card" style="background:#0f1220;border:1px solid #2a3147;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
            <button id="btn-load" class="btn ghost" style="flex:1">Load Game</button>
            <button id="btn-delete-all" class="btn ghost small" title="Delete all saves shown">Delete All</button>
          </div>
          <div id="load-list" class="grid" style="display:none;gap:8px;margin-top:10px">
            <div id="load-header" class="muted">Your previously hosted sessions:</div>
            <div id="load-items" class="grid" style="gap:8px"></div>
          </div>
        </div>
      </section>
    </div>
  </div>
</body>
</html>
